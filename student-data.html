<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kageyo TVET — Student Data Portal</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="icon" type="image/pn[jg" sizes="32x32" href="https://img.icons8.com/color/48/000000/student-center.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .card { border-radius: .75rem; box-shadow: 0 8px 24px rgba(2,6,23,0.06); }
    .class-btn { transition: background-color 0.2s; }
    .class-btn:hover { background-color: #2563eb; }
    .class-btn.active { background-color: #1e40af; color: white; }
    .student-name { 
      color: #2563eb; 
      cursor: pointer; 
      text-decoration: underline;
      transition: color 0.2s;
    }
    .student-name:hover { color: #1e40af; }
    .view-toggle-btn { 
      transition: all 0.2s; 
      border: 1px solid #2563eb;
    }
    .view-toggle-btn.active { 
      background-color: #2563eb; 
      color: white;
    }
    .discipline-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .discipline-excellent { background-color: #dcfce7; color: #166534; }
    .discipline-good { background-color: #f0f9ff; color: #0369a1; }
    .discipline-fair { background-color: #fef3c7; color: #92400e; }
    .discipline-poor { background-color: #fee2e2; color: #991b1b; }
    .violation-item { 
      border-left: 4px solid transparent;
      padding-left: 8px;
      margin-bottom: 4px;
    }
    .violation-late { border-left-color: #f59e0b; }
    .violation-uniform { border-left-color: #ef4444; }
    .violation-disruptive { border-left-color: #8b5cf6; }
    .violation-homework { border-left-color: #10b981; }
    .violation-disrespect { border-left-color: #dc2626; }
    .violation-fighting { border-left-color: #7c3aed; }
    .violation-other { border-left-color: #6b7280; }
    
    /* Excel-like table styling */
    .excel-table {
      border-collapse: collapse;
      width: 100%;
      font-size: 0.875rem;
    }
    .excel-table th, .excel-table td {
      border: 1px solid #d1d5db;
      padding: 6px 8px;
      text-align: left;
    }
    .excel-table th {
      background-color: #f3f4f6;
      font-weight: 600;
      position: sticky;
      top: 0;
    }
    .excel-table tr:nth-child(even) {
      background-color: #f9fafb;
    }
    .excel-table tr:hover {
      background-color: #eff6ff;
    }
    .editable-cell {
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .editable-cell:hover {
      background-color: #dbeafe;
    }
    .editable-cell.editing {
      background-color: #dbeafe;
      padding: 0;
    }
    .editable-cell input {
      width: 100%;
      border: none;
      outline: none;
      padding: 6px 8px;
      background-color: transparent;
      font-size: 0.875rem;
    }
    .save-btn {
      background-color: #10b981;
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      font-weight: 500;
      transition: background-color 0.2s;
    }
    .save-btn:hover {
      background-color: #059669;
    }
    .cancel-btn {
      background-color: #6b7280;
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      font-weight: 500;
      transition: background-color 0.2s;
    }
    .cancel-btn:hover {
      background-color: #4b5563;
    }
    .hidden {
      display: none;
    }
    .program-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-left: 8px;
    }
    .program-accounting { background-color: #e0f2fe; color: #0369a1; }
    .program-software { background-color: #f0fdf4; color: #166534; }
    .program-olevel { background-color: #fef7cd; color: #92400e; }
    .publish-status {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 500;
      margin-left: 8px;
    }
    .status-published { background-color: #dcfce7; color: #166534; }
    .status-draft { background-color: #fef3c7; color: #92400e; }
    .admin-panel {
      background-color: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
    }
    .admin-panel h3 {
      font-size: 1.125rem;
      font-weight: 600;
      color: #1e40af;
      margin-bottom: 12px;
    }
    .admin-controls {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    .admin-btn {
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: 500;
      transition: all 0.2s;
    }
    .publish-btn {
      background-color: #10b981;
      color: white;
    }
    .publish-btn:hover {
      background-color: #059669;
    }
    .unpublish-btn {
      background-color: #ef4444;
      color: white;
    }
    .unpublish-btn:hover {
      background-color: #dc2626;
    }
    .edit-btn {
      background-color: #3b82f6;
      color: white;
    }
    .edit-btn:hover {
      background-color: #2563eb;
    }
    .view-published-btn {
      background-color: #8b5cf6;
      color: white;
    }
    .view-published-btn:hover {
      background-color: #7c3aed;
    }
    .parent-login {
      background-color: #f0f9ff;
      border: 1px solid #bae6fd;
      border-radius: 8px;
      padding: 16px;
      margin-top: 20px;
    }
    .student-card {
      transition: all 0.2s;
      cursor: pointer;
    }
    .student-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .student-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #3b82f6;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }
    .stats-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 12px;
      padding: 16px;
    }
    .stats-value {
      font-size: 1.75rem;
      font-weight: bold;
    }
    .stats-label {
      font-size: 0.875rem;
      opacity: 0.9;
    }
    .search-box {
      position: relative;
    }
    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #6b7280;
    }
    .search-input {
      padding-left: 40px;
    }
    .filter-btn {
      transition: all 0.2s;
    }
    .filter-btn.active {
      background-color: #3b82f6;
      color: white;
    }
    .login-container {
      max-width: 400px;
      margin: 0 auto;
    }
    .login-tabs {
      display: flex;
      border-bottom: 1px solid #e5e7eb;
      margin-bottom: 1.5rem;
    }
    .login-tab {
      flex: 1;
      text-align: center;
      padding: 0.75rem;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    .login-tab.active {
      border-bottom-color: #3b82f6;
      color: #3b82f6;
      font-weight: 600;
    }
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 8px;
      color: white;
      z-index: 1000;
      opacity: 0;
      transform: translateY(-20px);
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }
    .toast.success { background-color: #10b981; }
    .toast.error { background-color: #ef4444; }
    .toast.warning { background-color: #f59e0b; }
    .toast.info { background-color: #3b82f6; }
    .grade-excellent { background-color: #dcfce7; color: #166534; }
    .grade-good { background-color: #dbeafe; color: #1e40af; }
    .grade-average { background-color: #fef3c7; color: #92400e; }
    .grade-poor { background-color: #fee2e2; color: #991b1b; }
    .grade-cell {
      text-align: center;
      font-weight: 600;
      border-radius: 4px;
      padding: 4px 8px;
    }
    .academic-results {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      overflow: hidden;
      margin-bottom: 20px;
    }
    .academic-results-header {
      background: linear-gradient(135deg, #1a73e8, #6c8ef5);
      color: white;
      padding: 20px;
    }
    .academic-results-body {
      padding: 20px;
    }
    .results-table {
      width: 100%;
      border-collapse: collapse;
    }
    .results-table th {
      background-color: #f1f5fd;
      color: #1a73e8;
      font-weight: 600;
      text-align: left;
      padding: 12px 15px;
      border-bottom: 2px solid #e0e7ff;
    }
    .results-table td {
      padding: 12px 15px;
      border-bottom: 1px solid #eaeaea;
    }
    .results-table tr:hover {
      background-color: #f9fafc;
    }
    .results-table .highlight {
      font-weight: bold;
      color: #1a73e8;
    }
    .results-table .year-total {
      background-color: #f1f5fd;
      font-weight: bold;
    }
    .performance-summary {
      display: flex;
      justify-content: space-between;
      margin-top: 30px;
      background: #f9fafc;
      padding: 20px;
      border-radius: 8px;
      border-left: 4px solid #1a73e8;
    }
    .summary-item {
      text-align: center;
      flex: 1;
    }
    .summary-value {
      font-size: 32px;
      font-weight: bold;
      color: #1a73e8;
      margin: 10px 0;
    }
    .summary-label {
      font-size: 14px;
      color: #666;
    }
    .download-btn {
      background-color: #1a73e8;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background-color 0.2s;
    }
    .download-btn:hover {
      background-color: #0d62d9;
    }
    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
  </style>
</head>
<body class="bg-gray-50 font-sans antialiased text-gray-800">
  <!-- HEADER / NAVBAR -->
  <header class="bg-white shadow-sm">
    <div class="bg-blue-600 text-white py-2">
      <div class="container mx-auto px-4 flex justify-between items-center">
        <a href="#" class="hover:underline"><i class="fab fa-whatsapp mr-2"></i>Join WhatsApp Group</a>
        <select id="header-language-selector" class="p-1 rounded bg-white text-blue-600">
          <option value="en">English</option>
          <option value="rw">Kinyarwanda</option>
          <option value="fr">Français</option>
        </select>
      </div>
    </div>
    <div class="container mx-auto px-4 py-4">
      <nav class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <a href='/'>
            <div class="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold text-xl">
              KT
            </div>
          </a>
          <div>
            <a class='text-xl font-bold text-blue-600' href='/'>KAGEYO TVET SCHOOL</a>
            <div class="text-sm text-gray-500">Work - Courage - Solidarity</div>
          </div>
        </div>
        <div class="hidden md:flex items-center space-x-6">
          <a class='text-blue-600 hover:text-blue-800' href='/'>Home</a>
          <a class='text-blue-600 hover:text-blue-800' href='/about'>About Us</a>
          <a class='text-blue-600 hover:text-blue-800' href='/student-data'>Student Portal</a>
          <a class='text-blue-600 hover:text-blue-800' href='/contact'>Contact</a>
          <button id="headerLoginBtn" class='px-3 py-2 bg-blue-600 text-white rounded'>Login</button>
        </div>
      </nav>
    </div>
  </header>

  <!-- MAIN CONTENT -->
  <main class="container mx-auto px-4 py-6">
    <section class="card bg-white p-6">
      <!-- Login Section -->
      <div id="loginSection">
        <div class="login-container">
          <h1 class="text-2xl font-bold text-blue-700 mb-6 text-center">Student Data Portal</h1>
          
          <div class="login-tabs">
            <div class="login-tab active" data-tab="student">Student Login</div>
            <div class="login-tab" data-tab="parent">Parent Login</div>
            <div class="login-tab" data-tab="admin">Admin Login</div>
          </div>
          
          <!-- Student Login Form -->
          <div id="studentLoginForm" class="login-form">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
              <p class="text-sm text-gray-700 mb-4">Please enter your name and class to access your academic records.</p>
              
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                  <input type="text" id="studentName" placeholder="Enter your full name" 
                         class="w-full border rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-600">
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Class</label>
                  <select id="studentClass" class="w-full border rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-600">
                    <option value="">Select your class</option>
                    <optgroup label="Software Development">
                      <option value="L3 SWD">L3 SWD</option>
                      <option value="L4 SWD">L4 SWD</option>
                    </optgroup>
                    <optgroup label="Accounting">
                      <option value="S5A">S5A</option>
                      <option value="S5B">S5B</option>
                      <option value="S6A">S6A</option>
                      <option value="S6B">S6B</option>
                    </optgroup>
                    <optgroup label="O'Level">
                      <option value="S1A">S1A</option>
                      <option value="S1B">S1B</option>
                      <option value="S2A">S2A</option>
                      <option value="S2B">S2B</option>
                      <option value="S3A">S3A</option>
                      <option value="S3B">S3B</option>
                      <option value="S4A">S4A</option>
                      <option value="S4B">S4B</option>
                    </optgroup>
                  </select>
                </div>
                
                <button id="studentLoginBtn" class="w-full px-4 py-2 bg-blue-600 text-white rounded font-semibold hover:bg-blue-700 transition">
                  Login to Student Portal
                </button>
              </div>
            </div>
          </div>
          
          <!-- Parent Login Form -->
          <div id="parentLoginForm" class="login-form hidden">
            <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-6">
              <p class="text-sm text-gray-700 mb-4">Parents can view their child's results using the student's name and class.</p>
              
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Student's Full Name</label>
                  <input type="text" id="parentStudentName" placeholder="Enter student's full name" 
                         class="w-full border rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-600">
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Student's Class</label>
                  <select id="parentStudentClass" class="w-full border rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-600">
                    <option value="">Select student's class</option>
                    <optgroup label="Software Development">
                      <option value="L3 SWD">L3 SWD</option>
                      <option value="L4 SWD">L4 SWD</option>
                    </optgroup>
                    <optgroup label="Accounting">
                      <option value="S5A">S5A</option>
                      <option value="S5B">S5B</option>
                      <option value="S6A">S6A</option>
                      <option value="S6B">S6B</option>
                    </optgroup>
                    <optgroup label="O'Level">
                      <option value="S1A">S1A</option>
                      <option value="S1B">S1B</option>
                      <option value="S2A">S2A</option>
                      <option value="S2B">S2B</option>
                      <option value="S3A">S3A</option>
                      <option value="S3B">S3B</option>
                      <option value="S4A">S4A</option>
                      <option value="S4B">S4B</option>
                    </optgroup>
                  </select>
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Parent Name</label>
                  <input type="text" id="parentName" placeholder="Enter your name" 
                         class="w-full border rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-600">
                </div>
                
                <button id="parentLoginBtn" class="w-full px-4 py-2 bg-purple-600 text-white rounded font-semibold hover:bg-purple-700 transition">
                  Login as Parent
                </button>
              </div>
            </div>
          </div>
          
          <!-- Admin Login Form -->
          <div id="adminLoginForm" class="login-form hidden">
            <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
              <p class="text-sm text-gray-700 mb-4">Administrators can manage and publish student results.</p>
              
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                  <input type="text" id="adminUsername" placeholder="Enter admin username" 
                         class="w-full border rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-green-600">
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                  <input type="password" id="adminPassword" placeholder="Enter admin password" 
                         class="w-full border rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-green-600">
                </div>
                
                <button id="adminLoginBtn" class="w-full px-4 py-2 bg-green-600 text-white rounded font-semibold hover:bg-green-700 transition">
                  Login as Administrator
                </button>
              </div>
            </div>
          </div>
          
          <div id="loginError" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
            <p class="text-sm text-red-700" id="loginErrorMessage">Invalid credentials. Please check your information and try again.</p>
          </div>
        </div>
      </div>
      
      <!-- Main Content (Hidden by default) -->
      <div id="content" class="hidden">
        <div class="flex items-start justify-between">
          <div>
            <h1 class="text-xl font-bold text-blue-700">Student Data Portal</h1>
            <p class="text-sm text-gray-600" id="userRoleText">View academic marks and disciplinary records with calculated totals and rankings for the academic year.</p>
          </div>
          <div class="text-right text-sm text-gray-500">
            Academic Year: <strong>2025 - 2026</strong>
            <br>
            <button id="logoutBtn" class="mt-2 text-xs text-red-600 hover:text-red-800 underline">Logout</button>
          </div>
        </div>

        <!-- Admin Panel (Hidden by default) -->
        <div id="adminPanel" class="admin-panel hidden">
          <h3>Administrator Panel</h3>
          <div class="admin-controls">
            <button id="publishBtn" class="admin-btn publish-btn">
              <i class="fas fa-upload mr-2"></i>Publish All Results
            </button>
            <button id="unpublishBtn" class="admin-btn unpublish-btn">
              <i class="fas fa-times mr-2"></i>Unpublish All Results
            </button>
            <button id="editModeBtn" class="admin-btn edit-btn">
              <i class="fas fa-edit mr-2"></i>Toggle Edit Mode
            </button>
            <button id="viewPublishedBtn" class="admin-btn view-published-btn">
              <i class="fas fa-eye mr-2"></i>View Published Data
            </button>
          </div>
        </div>

        <!-- Real-Time Sync Status -->
        <div class="my-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
          <div class="flex items-center">
            <i class="fas fa-sync-alt text-blue-600 mr-2"></i>
            <span class="text-sm text-blue-700">Marks are updated in real-time. View your latest results below.</span>
          </div>
        </div>

        <!-- Student Selection (Admin View) -->
        <div id="studentSelection" class="hidden">
          <div class="mb-6">
            <h3 class="text-lg font-semibold text-blue-700 mb-4">Select Student</h3>
            
            <!-- Search and Filter Controls -->
            <div class="flex flex-col md:flex-row gap-4 mb-4">
              <div class="search-box flex-1">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="studentSearch" placeholder="Search students by name..." class="w-full border rounded px-3 py-2 text-sm search-input focus:outline-none focus:ring-2 focus:ring-blue-600">
              </div>
              <div class="flex gap-2">
                <button class="filter-btn px-3 py-2 border rounded text-sm active" data-class="all">All Classes</button>
                <button class="filter-btn px-3 py-2 border rounded text-sm" data-class="S1">S1</button>
                <button class="filter-btn px-3 py-2 border rounded text-sm" data-class="S2">S2</button>
                <button class="filter-btn px-3 py-2 border rounded text-sm" data-class="S3">S3</button>
                <button class="filter-btn px-3 py-2 border rounded text-sm" data-class="S4">S4</button>
                <button class="filter-btn px-3 py-2 border rounded text-sm" data-class="S5">S5</button>
                <button class="filter-btn px-3 py-2 border rounded text-sm" data-class="S6">S6</button>
                <button class="filter-btn px-3 py-2 border rounded text-sm" data-class="SWD">SWD</button>
              </div>
            </div>
            
            <!-- Student Grid -->
            <div id="studentGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-96 overflow-y-auto p-2">
              <!-- Students will be populated here -->
            </div>
          </div>
        </div>

        <!-- View Toggle -->
        <div class="my-4">
          <h3 class="text-sm font-semibold text-gray-700 mb-2">View Options</h3>
          <div class="flex flex-wrap gap-2">
            <button id="viewMyMarksBtn" class="view-toggle-btn px-3 py-1 rounded text-sm font-medium active">
              View Academic Marks
            </button>
            <button id="viewMidtermBtn" class="view-toggle-btn px-3 py-1 rounded text-sm font-medium text-blue-600">
              View Midterm Marks
            </button>
            <button id="viewDisciplineBtn" class="view-toggle-btn px-3 py-1 rounded text-sm font-medium text-blue-600">
              View Discipline Record
            </button>
            <button id="viewAcademicResultsBtn" class="view-toggle-btn px-3 py-1 rounded text-sm font-medium text-blue-600">
              View Academic Results
            </button>
          </div>
        </div>

        <!-- My Marks Section -->
        <div id="myMarksSection">
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
            <h3 class="text-lg font-semibold text-blue-700 mb-3">Academic Marks</h3>
            <div id="myMarksContent">
              <!-- My marks will be populated here -->
            </div>
          </div>
        </div>

        <!-- Discipline Records Section -->
        <div id="disciplineSection" class="hidden">
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
            <h3 class="text-lg font-semibold text-blue-700 mb-3">Disciplinary Records</h3>
            <div class="mb-4">
              <p class="text-sm text-gray-600 mb-2">Students start with 40 marks per term. Violations deduct marks from this total.</p>
              <div class="flex flex-wrap gap-2">
                <span class="discipline-badge discipline-excellent">Excellent: 36-40 marks</span>
                <span class="discipline-badge discipline-good">Good: 30-35 marks</span>
                <span class="discipline-badge discipline-fair">Fair: 20-29 marks</span>
                <span class="discipline-badge discipline-poor">Poor: Below 20 marks</span>
              </div>
            </div>
            <div id="disciplineContent">
              <!-- Discipline records will be populated here -->
            </div>
          </div>
        </div>

          <!-- Midterm Marks Section -->
          <div id="midtermSection" class="hidden">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
              <h3 class="text-lg font-semibold text-blue-700 mb-3">Midterm Marks</h3>
              <div id="midtermContent">
                <!-- Midterm marks will be populated here -->
              </div>
            </div>
          </div>

          <!-- Academic Results Section -->
          <div id="academicResultsSection" class="hidden">
          <div class="academic-results">
            <div class="academic-results-header">
              <h2 class="text-xl font-bold">Academic Results</h2>
              <div class="mt-2">
                <p class="text-sm opacity-90" id="resultsStudentName">Student: ABIMANA HIRWA Gary Blessing</p>
                <p class="text-sm opacity-90" id="resultsStudentClass">Class: S1A</p>
              </div>
            </div>
            <div class="academic-results-body">
              <h3 class="text-lg font-semibold text-blue-700 mb-4">O'Level</h3>
              
              <div class="overflow-x-auto">
                <table class="results-table">
                  <thead>
                    <tr>
                      <th>Term</th>
                      <th>Average Mark</th>
                      <th>Class Average</th>
                      <th>Position</th>
                      <th>Grade</th>
                      <th>Remarks</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="resultsTableBody">
                    <!-- Results will be populated here -->
                  </tbody>
                </table>
              </div>
              
              <div class="performance-summary">
                <div class="summary-item">
                  <div class="summary-label">Overall Average</div>
                  <div class="summary-value" id="overallAverage">85%</div>
                </div>
                <div class="summary-item">
                  <div class="summary-label">Class Position</div>
                  <div class="summary-value" id="classPosition">3</div>
                </div>
                <div class="summary-item">
                  <div class="summary-label">Final Grade</div>
                  <div class="summary-value" id="finalGrade">A+</div>
                </div>
              </div>
              
              <div class="action-buttons">
                <button id="downloadResultsBtn" class="download-btn">
                  <i class="fas fa-download"></i> Download Results as PDF
                </button>
                <button id="calculateResultsBtn" class="download-btn" style="background-color: #10b981;">
                  <i class="fas fa-calculator"></i> Calculate Results
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>

  <!-- SCRIPT -->
  <script>
    // Student data from the Excel file
    const studentData = {
      "S1A": [
        "ABEREYIMANA James", "ABIMANA HIRWA Gany Blessing", "AHISHAKIYE MANZI Aime Miguel", 
        "ASHIMWE Nate Brayan", "Benedicto King Samuel", "BUGINGO BEZA Keny", 
        "GASHUMBA NDAYISHIMIYE KIM Kenedy", "IGENUKWISHATSE BYISHIMO Jean Maurice", 
        "IGIRANEZA CYUSA Milton", "IHUMURE NSENGIYUMVA Heroine", "INEZA Queen Deborah", 
        "IRABARUTA MUGISHA Credo", "IRAKOZE Belle Amie", "IRAKOZE Janviere", 
        "IRAKOZE Yanis", "ISHIMWE UWASE Gabriella", "ISIMBI UWASE Joyeuse", 
        "ITANGANEZA Parfait", "KAMIKAZI Patience", "MUNEZERO Enock", 
        "MUNEZERO Priscilla", "MUTONIWASE Benitha", "MUVUNYI UWIMPUHWE Benie Hortance", 
        "MWITENEZA Jean Pierre", "NDARUHUTSE Danny", "NGABONZIZA MUGISHA Boris", 
        "NGANZO Born Bercee", "RORIRORA Gihozo Anella", "UWANYAGASANI Cedrick", 
        "UWASE Benitha", "UWIDUHAYE Pascaline", "UWINEZA AKALIZA Martina", 
        "UWIZEYIMANA Valentine", "YUBAHWE Anitha"
      ],
      "S1B": [
        "ABAYISENGA Emmu Shalom", "AMANI NSHUTI Claver", "ARERWENEZA Laetitia", 
        "BAGABE Dieudonne", "CYOMORO Nicky Prince", "GAGA Lioness", 
        "IGANZE Olla Mireille", "IGIRIMBABAZI Pamella", "INEZA Aure Alexandrine", 
        "INEZA Deborah", "INEZA KAMIKAZI TETA Promesse", "IRAGENA Gloria", 
        "IRAGENA Laetitia", "IRAME MUCYO Angelo", "ISHEMA Rayan", 
        "ISHIMWE NGABO Hertier", "ISHIMWE Olga", "ISINGIZWE Ange Afurika Maombe", 
        "KAYITARE Caleb", "KEZA UMI Abdoulatomani", "KUNDA Beny Bienaime", 
        "KWIZERA MUHOZA Prince", "MANZI Boaz", "MBABAZI Blessed", 
        "MUNEZERO Gentil Hertier", "MUNEZERO Yvette", "MUTONIWASE Esther", 
        "NDIKUMWENAYO Jeannette", "NIRAGIRE Aline", "NIYONZIMA Lucky", 
        "RUDASINGWA", "SHAMI Ianis Vangelis", "UWASE GASARO Kelia", 
        "UWASE Sendrine", "UWIZEYIMANA Chakilla", "UYIZERA Regis"
      ],
      "S2A": [
        "BYISHIMO Remy", "BAHO AKARIZA Kevine", "DUKUZUMUREMYI Janvier", 
        "GANZA AHADI TRESOR", "IHIRWE Benitha", "IKUNDABAYO Kevin", 
        "IMFURAYASE Aimee Ange", "INEZA QUEEN LOVE", "INEZA Ryan Merci", 
        "IRASUBIZA NANSI Nadia Lenatha", "ISHIMWE Brianna", "ISUMBINGABO HIRWA HERVE", 
        "KALIZA UNEJEJE Ella  Blassia", "KAREKEZI SHIMWA SYLIVIE", "KWIZE David", 
        "KWIZERA Richard", "MANZI GANZA Fred", "MBABAZI DORCAS", 
        "MUBIIRIGI Cyusa Prince", "MUCYO MUGWANEZA Magnifique", "MUSENGIMANA Marie Divine", 
        "NGABO Prince", "NIYOMUKIZA STANISLAS", "NIZEYIMANA Etienne", 
        "NYIRAHABAMUNGU Janviere", "SHEMA NZAYITURIKI Benoit", "TUYIZERE Solange", 
        "UFITEYEZU SERGE", "UMUKUNDWA QUEEN VANESSA", "UWAMASHIMWE JEANNETTE", 
        "UWASE Fabiola", "UWIMANA Fideline", "UWIMPUHWE JEROME", 
        "UWIZEYIMANA Patrick"
      ],
      "S2B": [
        "ABE MUGISHA Antoine", "ABIJURU Gift Kelly Joel", "AGASARO Liza Briante", 
        "CYOMORO NIYONZIMA Iba Bright", "GIRUMUGISHA MASSIMO", "HERO KARENGERA Keutch", 
        "HIRWA KAZE  Danyllo", "IGIHOZO Kellia", "IGIKUNDIRO Fiston", 
        "IRERA PROMISE", "IRIZA GWIZA Clenie", "ISHIMWE  YVETTE", 
        "ISHIMWE Belyse", "ISHIMWE NGABO Victory", "KABANDA RUTERANA He Calvin", 
        "KAMALI IGIHOZO IRANZI Marie Mercie", "KEZA SANGWA DIVINE", 
        "KWIBUKA GIFT CARTINE Arnal", "MARIYAMUNGU JUDITH", "MUTAGANDA Micky", 
        "NDAMUKUNDA GISA CHANELLA", "NEZA LIZA Kenia", "NIKWIMANIGIZE Bonheur", 
        "NIWEKARABO KELIA WIVINE", "RWEMA NTETE Arthur", "SEBAHIRE MUHINEZA Emmaus", 
        "TURIKUMWE LOVE MORE", "TUYIZERE Mudathiru", "UMWARI GATETE Christa", 
        "UWASE GIHOZO Chanella", "UWINSHUTI Evelyne"
      ],
      "S3A": [
        "ABAYO Samuella", "BYIRINGIRO GWIZA SALOMON", "IGIHOZO EVA ALLEN QUEEN", 
        "IGIZENEZA Benoit Gratus", "IHIRWE FLORA", "IHOZO Carine", 
        "IKUZWE TETA LEATITIA", "INEZA Confiance Princesse", "INEZA PIERRA", 
        "INEZA RUTAYISIRE Kellia", "ISHIMWE KEVIN PRINCE", "ISHIMWE NOELLA", 
        "KAYITARE Brave", "MBIKESHIMANA SECONDINE", "MUGANWA MAURICE", 
        "MUSHIME ISHEJA Natasha", "MUYISENGE Gisele", "NIWEMUGENI GENNIFER", 
        "NIYIBIZI ESPERANCE", "NIYIGENA JEANNETTE", "NIYO IGIRANEZA Emmanuel", 
        "NIYOGIKUNDIRO PASCALINE", "NIYOMUKIZA ANYSIA", "NIYO NGENZI DAVE FRIEND", 
        "NKURUNZIZA INEZA Messi", "NSENGIMANA Benjamin", "NTIVUGURUZWA Samuel", 
        "RUKUNDO Djabil", "SHAMI IRAKOZE ALLIANCE", "SHEMA HAGUMA Prince Gabin", 
        "TETA MARIE CLAIRE", "TETERO Lucie", "UMUGANWA Hidaya Aisha", 
        "UMUKUMBURWA MPETA FIDELINE", "UWOYIREMEYE Faida"
      ],
      "S3B": [
        "AKIMANIZANYE AGNES", "ASHIMWE Aime Gloria", "DUSABIMANA NIYIGENA Aline", 
        "GIHOZO IRIZA ENOLLA", "HAKIZUMWAMI Samuel", "HIRWA MANZI HAPPINESS", 
        "IGIRANEZA ESTHER", "IHIRWE NSHUTI Ian Jadyne", "IKUZO ELLA", 
        "IKUZWE ADUHIRE Louange", "INEMA SYLVIA HEAVEN", "INEZA NSHUTI HERVE", 
        "INEZA Peace", "INGABIRE Ines", "IRAGENA CYIZA Belyse", 
        "KATUSIME Jeanne d'Arc", "MIZERO Aliane", "MUGABEKAZI Parfaite", 
        "MUHAWENIMANA Nadine", "MUNEZERO  ROSINE", "MUSENGIMANA Ella Joy", 
        "MUTESA NELICKY", "NGANZO Nalada", "NIRAGIRE MIGNONE", 
        "NIYIGENA MUCYO MERCI MAXIME", "NIYONGIRA Rene", "NIYUBAHWE BIRORI Gloria", 
        "NTWALI SHEMA Honore", "PENDA Oceanne Pamella", "TUYISHIMIRE KEVINE", 
        "UMUBYEYI SENGA Benigne", "UMUHIRE  Keza Odreille", "UMWARI FIONA", 
        "UMWARI Natasha", "UWIZEYE IRASUBIZA ERNESTINE"
      ],
      "L3 SWD": [
        "ABIZERIMANA Benitha", "AHISHAKIYE Janvier", "BYIRINGIRO Eric", 
        "CYUBAHIRO Jackson", "CYUZUZO Isaac", "GIKUNDIRO Sandrine", 
        "HABIMANA Hamis", "IBYIZA Speratha", "IGIHOZO Frorence", 
        "INEZA MUGISHA Landry", "INEZA TETA Gloria", "IRABIZI Bowaze", 
        "IRAGENA Sendrine", "IRASUBIZA Emille", "IZABAYO Yves", 
        "KURUGISHURI Samson", "KWIZERA Gad", "MANISHIMWE Jean de Dieu", 
        "MUGISHA Brian", "MUGISHA Isaac", "MUNEZERO Danny", 
        "MUSHIMIYIMANA Marie Reine", "MUSHIMIYIMANA Sumaya", "MUSINGUZI Emmanuel", 
        "NDUWAYEZU Theophile", "NIRAGIRE Daphine", "NISHIMIRWE ISUBIRIZIGIHE Dani", 
        "NIWEMUGENI Liliane", "NIYOGUSHIMWA Ange Christian", "NIYONASENZE Beulla", 
        "NIYONKURU Vradimir", "NYISHIMENTE Naome Nadine", "TUGIRINSHUTI Evariste", 
        "TURINIMANA Augustin", "TUYISHIMIRE Solange", "UWUMUGISHA Pacifique", 
        "UMUTOZO Eduige", "UMWARI Josiane", "UWAMAHORO Ange UWASE", 
        "UWIDUHAYE Theodette", "UWIMBABAZI Lydie", "UWIMPUHWE Nadia", 
        "UWINGENEYE Claire"
      ],
      "S4A": [
        "ABERA Esther", "ABIJURU Josiane", "BYIRINGIRO Justine", 
        "IGIZENEZA Divine", "INEZA Alliance Benie", "INGABIRE KAYIBANDA Germaine", 
        "IRAGENA KAYIRANGWA Elysa", "IRAGENA Solange", "IRAKOZE Aime", 
        "IRAKOZE Pascaline", "ISHIMWE Fabrice", "ISHIMWE TUYISENGE Emma", 
        "ISHIMWE Velentine", "ITUZE GWIZA Sabrine", "KAMIKAZI Derlene", 
        "KEZA EPA", "MASEZERANO Fabrice", "MBARUTSO IKUNDWE Bertin", 
        "MINAKUZESA Amina", "MUCYO Ignace Omega", "MUGABE Robert", 
        "MUKAHIRWA Julienne", "MUKIRE WINNY Nicole", "MUKUNDWA Faith", 
        "MUNEZERO Clemence", "MUSHIMIYIMANA Angelique", "MUTAMBA Xenie", 
        "NAMAHIRWE Ebenizelle", "NDAYIZEYE Angelique", "NIYOBYOSE Revelien", 
        "NIYONAMBAZA Elina", "NYIHANZAMASO Yvette", "NYIRAMUGISHA Berthilde", 
        "NYIRANSENGIYUMVA Aliance", "NZAYISENGA Vanessa", "SHIMIRWA Caline", 
        "TUMUSHIME Vedaste", "TUYISHIMIRE Divine", "TWAGIRIMANA Riberee", 
        "UMUGWANEZA Pascaline", "UWAMARIYA Enysia", "UWASE KABUGO Aline", 
        "UWASE Nicole", "UWIMANA Odila"
      ],
      "S4B": [
        "AKIMANA Cecile", "AMIZERO Nadine", "ASHIMIMANA Clementine", 
        "BAHATI Cleb", "GAHONGAYIRE Pauline", "GIKUNDIRO TUMUKUNDE Emelyne", 
        "HIRWA Bertin", "HIRWA Fabrice", "HUMURIZIBYOSE Ange", 
        "IGIRANEZA David", "IGIRIMBABAZI Emelyne", "INEZA Joy", 
        "INEZA Veronique", "IRADUKUNDA Immaculee", "IRADUKUNDA Rahab", 
        "IRAKOZE Marlene", "IRANZI Aime", "MUHAWENIMANA Noella", 
        "MUKESHIMANA Jeannette", "MUNYANA Kellen", "MUSHIMIYIMANA Henriette", 
        "MUTONI Queen", "NIYONIZEYE Jean d'Amour", "NIZIGIYIMANA Banjamin", 
        "NSHIMIYUMUKIZA Liliane", "TUMUKUNDE Kevine", "TURATSINZE Emmanuel", 
        "TUYAMBAZE Beatha", "TUYISHIMIRE Marie Grace", "UMUGWANEZA Beyonce", 
        "UMUGWANEZA Scovia", "UMUKUNDWA Kelly", "UMUTONI Pascaline", 
        "UMUTONIWASE Blandine", "UWAMAHORO Zawadi", "UWASE Jeannine", 
        "UWASE SANGWA Kevine", "UWAYEZU Fiacrine", "UWAYO Ester", 
        "UWIMANA Alice", "UWITUZE Melisa", "UWIZEYIMANA Odette", 
        "UWIZEYIMANA Sarah"
      ],
      "L4 SWD": [
        "BIRORI Honorine", "CYUZUZO Emile", "DUSABE Anne Peline", 
        "GIKUNDIRO Shalom", "GISUBIZO HIRWA Bonheur", "GISUBIZO Jean Claude", 
        "IBANENATWE Gisele", "INEZA Alida", "IRADUKUNDA Josiane", 
        "IRAKOZE Hyacinthe", "IRANKA Pacifique", "IRANZI Naome", 
        "IRUMVA HIRWA Arsene", "ISHEMA Christian", "ISHIMWE Jeanne Gentille", 
        "ISIMBI Golden", "IZABAYO Emeritha", "KWIZERA Derick", 
        "MUGISHA Aime Kevin", "MUGISHA Arnold", "MUNEZA Hillo Blandeco", 
        "MUPENZI Cedrick", "NDAHIDWA Arnould", "NDATIMANA Dodoce", 
        "NDIZIHIWE Alain Delys", "NIRERE Evangeline", "NISHIMWE Olive", 
        "NIYO Esther Kevine", "NSHIMIYIMANA  Dominique", "NTAGARAMA Teta Cynthia", 
        "NYIRAGUHIRWA Kevine", "NYIRAMANA Jeanne", "SHYAKA Clever Prince", 
        "TONY RAY Hilde", "TURINAYO AMANI Basil", "UMWIZERWA Sandrine", 
        "USANASE Benitha", "UWASE Belyse", "UWASE Gloria", 
        "WIBABARA Janici"
      ],
      "S5A": [
        "AHISHAKIYE Annualithe", "BYUKUSENGE Adeline", "GIKUNDIRO Kessia", 
        "HAVUGIMANA Girbert", "IGIRANEZA Dorcas", "INGABIRE Sifa", 
        "IRADUKUNDA Confiance", "IRAGANJE Thanks", "IRAKOZE Dorcas", 
        "IYAMUMPAYE  Julienne", "KANGUME Ines", "MUGANWA Fulgence", 
        "MUKAHIRWA Benitha", "MUKIZA  Leonce", "MUSANGANYA Elyse", 
        "MUTONIWASE  Delphine", "NDAYISHIMIYE Lambert", "NIYIBIZI Samuel", 
        "NIYIDUHA  Carine", "NIYINGABIRA Evelyne", "TETA REPONSE  Meghan", 
        "UNEZEREWE  Ange Sharom", "UWASE BWANAKWELI Scovia", "UWASE Pauline", 
        "UWITUZE Sandrine", "UWURUKUNDO Rosine", "ZIGIRIMENA Darlene"
      ],
      "S5B": [
        "CYUZUZO  Angel", "CYUZUZO Ange Benigne", "DUSHIMIMANA Jehovajureh", 
        "DUSHIMIYIMANA  Rosine", "DUSINGIZIMANA Queen", "IRADUHAYE Bless", 
        "ISHIMO AKARIZA Ange Sabrine", "ISHIMWE  Fabiola Aime", "ISHIMWE  Cynthia", 
        "ISHIMWE Clarisse", "ISHIMWE Frank", "ISHIMWE MPANO Honoline", 
        "IYONASENZE Bonheur", "MANIRATANGA Elie", "MANIRIHO  Jean Paul", 
        "NAMUKUNDIYICYO Pascaline", "NIYONSHUTI Bruno", "NIYUBAHWE Giselle", 
        "NTWARI NZABARINDA Guillaume", "NYIRABAGENI Leonille", "TUYIKUNDE  Marie Ange", 
        "UMWARIWASE Stella Divine", "UWAMAHORO HIRWA Berthe", "UWAMURERA Anitha", 
        "UWIDUHAYE Belise", "UWIHANGANYE  Ezechiel"
      ],
      "S6A": [
        "BENIHIRWE DATIVE", "DUSABIRANE DORCAS", "IFASHUWACU KEVINE", 
        "IMFURANASE AIME PATRICK", "INGABIRE DIVINE", "IRAKARAMA NATALIE", 
        "KABATESI PHIONAH", "MUHONGERWA DIANE", "MUKAMABANO Agnes", 
        "MUKAMUGABO LILIANE", "MUKAMUGISHA DEVOTHE", "MUKARUKUNDO CLARISSE", 
        "MUKESHIMANA MICHELINE", "MUNEZERO DENYSE", "MUREKAZE GAUDENCE", 
        "MUSHIMIYIMANA CLAUDINE", "MUTEZIMANA ANGELINA", "MUTUYIMANA ANITHA", 
        "NISHIMWE UWIJURU ESTHER", "NIYIKORA DELIPHINE", "NIYITANGINGABIRE LAURENCE", 
        "NIYOMUTABAZI ISMAEL", "NIYONGIRA INNOCENT", "NIYONSENGA CLARISSE", 
        "PRINCE Anathole Nobel", "SANGWA EDEN SHALOM", "TUMUSIFU EVANGELINE", 
        "TUYISHIME Eliane", "TUYIZERE Marie Ange", "UMUHUZA HELENE", 
        "UMURISA HOGOZA Benize", "UMUTONI Alice", "UMUTONIWASE STEPHANIE", 
        "UMUTONIWASE enatha", "UWABEZA Charlotte", "UWAMAHORO BEATHA", 
        "UWAMBAJIMANA DIANE", "UWINEZA JOSIANE", "UWINEZA Henriette", 
        "UWIRAGIYE Joselyne", "UWUMUGISHA Consolee"
      ],
      "S6B": [
        "AHIMBAZWE CONSTANT", "AKURUKUNDO Adeline", "DUSHIMIMANA Albine", 
        "DUSINGIZIMANA Monica", "DUSINGIZIMANA Faustine", "GASARO Lucky", 
        "IRATUZI PRINCE", "ISHIMWE Clementine", "IYAMUDUHAYE FORTUNEE", 
        "KAYESU HOPE", "KAYESU FLORENCE", "KIREZI ANGEL", "MUGANWA JOYCE", 
        "MUGENIWAYEZU HENRIETTE", "MUHAWIMANA Aline", "MUHORAKEYE ALLIANCE", 
        "MUKANDAYISHIMIYE Sylivie", "MUTIMAWURUGO ESTHER", "MUTONIWASE Bella", 
        "NDACYAYISENGA ANITHA", "NDAYISHIMIYE SAMUEL", "NIKUZE Jean Pierre", 
        "NIRERE LOUISE", "NIYINDEMERA MUTABARUKA Eunice Helena", "NIYINGENERA JOYEUSE", 
        "NIYOKWIZERWA LILIANE", "NIYONAGIZE AZELE", "NYAMPINGA PROVIDENCE", 
        "NYIRAKANYANA Sandrine", "NYIRANIZEYIMANA Clesence", "NYIRIMBABAZI Olive", 
        "TUYISENGE SANDRINE", "UMURORA JOSIANE", "UWAYISENGA ESPERANCE", 
        "UWERA Diane", "UWIDUHAYE CHARITE", "UWINEZA Jeanne d'Arc", 
        "UWINGABIRE Albertine", "UWIZESERANO SANDRINE", "UWONKUNDA Henriette", 
        "YEBARE PHIONAH"
      ]
    };

    // Mock term marks data (replacing subject marks)
    const termMarksData = {
      "S1A": {
        "ABEREYIMANA James": {
          program: "O'Level",
          terms: {
            "Term 1": { 
              average: 75, 
              position: 12,
              classAverage: 72,
              grade: "B+",
              remarks: "Good performance, consistent effort"
            },
            "Term 2": { 
              average: 78, 
              position: 10,
              classAverage: 74,
              grade: "A-",
              remarks: "Improved performance, active in class"
            },
            "Term 3": { 
              average: 82, 
              position: 8,
              classAverage: 76,
              grade: "A",
              remarks: "Excellent performance, shows great potential"
            }
          },
          yearTotal: {
            average: 78.3,
            position: 9,
            classAverage: 74,
            grade: "A-",
            remarks: "Consistent improvement throughout the year"
          }
        },
        "ABIMANA HIRWA Gany Blessing": {
          program: "O'Level",
          terms: {
            "Term 1": { 
              average: 82, 
              position: 5,
              classAverage: 72,
              grade: "A",
              remarks: "Excellent performance, shows leadership"
            },
            "Term 2": { 
              average: 85, 
              position: 3,
              classAverage: 74,
              grade: "A+",
              remarks: "Outstanding performance, very diligent"
            },
            "Term 3": { 
              average: 88, 
              position: 2,
              classAverage: 76,
              grade: "A+",
              remarks: "Exceptional performance, top of class"
            }
          },
          yearTotal: {
            average: 85,
            position: 3,
            classAverage: 74,
            grade: "A+",
            remarks: "Consistently high performer, excellent attitude"
          }
        }
      },
      "L3 SWD": {
        "ABIZERIMANA Benitha": {
          program: "Software Development",
          terms: {
            "Term 1": { 
              average: 85, 
              position: 8,
              classAverage: 78,
              grade: "A",
              remarks: "Strong technical skills, good problem solver"
            },
            "Term 2": { 
              average: 88, 
              position: 5,
              classAverage: 80,
              grade: "A+",
              remarks: "Excellent progress in programming skills"
            },
            "Term 3": { 
              average: 90, 
              position: 3,
              classAverage: 82,
              grade: "A+",
              remarks: "Outstanding performance in all technical areas"
            }
          },
          yearTotal: {
            average: 87.7,
            position: 5,
            classAverage: 80,
            grade: "A+",
            remarks: "Excellent technical aptitude, strong performer"
          }
        },
        "AHISHAKIYE Janvier": {
          program: "Software Development",
          terms: {
            "Term 1": { 
              average: 88, 
              position: 5,
              classAverage: 78,
              grade: "A+",
              remarks: "Excellent coding skills, very creative"
            },
            "Term 2": { 
              average: 90, 
              position: 2,
              classAverage: 80,
              grade: "A+",
              remarks: "Exceptional problem-solving abilities"
            },
            "Term 3": { 
              average: 92, 
              position: 1,
              classAverage: 82,
              grade: "A+",
              remarks: "Top performer, excellent in all areas"
            }
          },
          yearTotal: {
            average: 90,
            position: 1,
            classAverage: 80,
            grade: "A+",
            remarks: "Exceptional student, shows great potential in software development"
          }
        }
      },
      "S5A": {
        "AHISHAKIYE Annualithe": {
          program: "Accounting",
          terms: {
            "Term 1": { 
              average: 82, 
              position: 6,
              classAverage: 75,
              grade: "A",
              remarks: "Strong accounting fundamentals"
            },
            "Term 2": { 
              average: 85, 
              position: 4,
              classAverage: 77,
              grade: "A+",
              remarks: "Excellent progress in financial accounting"
            },
            "Term 3": { 
              average: 87, 
              position: 3,
              classAverage: 79,
              grade: "A+",
              remarks: "Outstanding performance in all accounting areas"
            }
          },
          yearTotal: {
            average: 84.7,
            position: 4,
            classAverage: 77,
            grade: "A+",
            remarks: "Excellent accounting student with strong analytical skills"
          }
        },
        "BYUKUSENGE Adeline": {
          program: "Accounting",
          terms: {
            "Term 1": { 
              average: 85, 
              position: 3,
              classAverage: 75,
              grade: "A+",
              remarks: "Excellent understanding of accounting principles"
            },
            "Term 2": { 
              average: 88, 
              position: 2,
              classAverage: 77,
              grade: "A+",
              remarks: "Outstanding performance in cost accounting"
            },
            "Term 3": { 
              average: 90, 
              position: 1,
              classAverage: 79,
              grade: "A+",
              remarks: "Exceptional performance, top of class"
            }
          },
          yearTotal: {
            average: 87.7,
            position: 1,
            classAverage: 77,
            grade: "A+",
            remarks: "Exceptional accounting student with excellent analytical skills"
          }
        }
      }
    };

    // Mock discipline data
    const disciplineData = {
      "S1A": {
        "ABEREYIMANA James": {
          term1: { marks: 38, violations: ["Late (2 times)"] },
          term2: { marks: 36, violations: ["Late (1 time)", "Uniform violation"] },
          term3: { marks: 40, violations: [] }
        },
        "ABIMANA HIRWA Gany Blessing": {
          term1: { marks: 40, violations: [] },
          term2: { marks: 39, violations: ["Late (1 time)"] },
          term3: { marks: 40, violations: [] }
        }
      },
      "L3 SWD": {
        "ABIZERIMANA Benitha": {
          term1: { marks: 35, violations: ["Late (3 times)", "Homework not done"] },
          term2: { marks: 38, violations: ["Late (1 time)"] },
          term3: { marks: 40, violations: [] }
        },
        "AHISHAKIYE Janvier": {
          term1: { marks: 40, violations: [] },
          term2: { marks: 40, violations: [] },
          term3: { marks: 39, violations: ["Late (1 time)"] }
        }
      },
      "S5A": {
        "AHISHAKIYE Annualithe": {
          term1: { marks: 37, violations: ["Late (2 times)"] },
          term2: { marks: 40, violations: [] },
          term3: { marks: 39, violations: ["Uniform violation"] }
        },
        "BYUKUSENGE Adeline": {
          term1: { marks: 40, violations: [] },
          term2: { marks: 40, violations: [] },
          term3: { marks: 40, violations: [] }
        }
      }
    };

    // Published data (initially empty, will be populated when published)
    let publishedData = {
      termMarks: {},
      disciplineData: {}
    };

    // User credentials
    const adminCredentials = {
      username: "admin",
      password: "kageyo2025"
    };

    // DOM elements
    const loginSection = document.getElementById('loginSection');
    const content = document.getElementById('content');
    const studentLoginBtn = document.getElementById('studentLoginBtn');
    const adminLoginBtn = document.getElementById('adminLoginBtn');
    const parentLoginBtn = document.getElementById('parentLoginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const studentNameInput = document.getElementById('studentName');
    const studentClassSelect = document.getElementById('studentClass');
    const parentStudentNameInput = document.getElementById('parentStudentName');
    const parentStudentClassSelect = document.getElementById('parentStudentClass');
    const parentNameInput = document.getElementById('parentName');
    const adminUsernameInput = document.getElementById('adminUsername');
    const adminPasswordInput = document.getElementById('adminPassword');
    const loginError = document.getElementById('loginError');
    const loginErrorMessage = document.getElementById('loginErrorMessage');
    const loginTabs = document.querySelectorAll('.login-tab');
    const loginForms = document.querySelectorAll('.login-form');
    const headerLoginBtn = document.getElementById('headerLoginBtn');
    const toast = document.getElementById('toast');
    
    // Content elements
    const viewMyMarksBtn = document.getElementById('viewMyMarksBtn');
    const viewMidtermBtn = document.getElementById('viewMidtermBtn');
    const viewDisciplineBtn = document.getElementById('viewDisciplineBtn');
    const viewAcademicResultsBtn = document.getElementById('viewAcademicResultsBtn');
    const myMarksSection = document.getElementById('myMarksSection');
    const midtermSection = document.getElementById('midtermSection');
    const disciplineSection = document.getElementById('disciplineSection');
    const academicResultsSection = document.getElementById('academicResultsSection');
    const myMarksContent = document.getElementById('myMarksContent');
    const midtermContent = document.getElementById('midtermContent');
    const disciplineContent = document.getElementById('disciplineContent');
    const adminPanel = document.getElementById('adminPanel');
    const publishBtn = document.getElementById('publishBtn');
    const unpublishBtn = document.getElementById('unpublishBtn');
    const editModeBtn = document.getElementById('editModeBtn');
    const viewPublishedBtn = document.getElementById('viewPublishedBtn');
    const publishStatus = document.getElementById('publishStatus');
    const publishedStatus = document.getElementById('publishedStatus');
    const studentSelection = document.getElementById('studentSelection');
    const studentGrid = document.getElementById('studentGrid');
    const studentSearch = document.getElementById('studentSearch');
    const userRoleText = document.getElementById('userRoleText');
    const downloadResultsBtn = document.getElementById('downloadResultsBtn');
    const calculateResultsBtn = document.getElementById('calculateResultsBtn');
    const resultsTableBody = document.getElementById('resultsTableBody');
    const resultsStudentName = document.getElementById('resultsStudentName');
    const resultsStudentClass = document.getElementById('resultsStudentClass');
    const overallAverage = document.getElementById('overallAverage');
    const classPosition = document.getElementById('classPosition');
    const finalGrade = document.getElementById('finalGrade');

    // Current user info
    let currentUser = null;
    let isAdmin = false;
    let isEditMode = false;
    let isViewingPublished = false;
    let selectedStudent = null;

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
      // Check if user is already logged in
      const savedUser = localStorage.getItem('currentUser');
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
        isAdmin = localStorage.getItem('isAdmin') === 'true';
        isViewingPublished = localStorage.getItem('isViewingPublished') === 'true';
        showContent();
      }
      
      // Listen for storage changes to update data when admin publishes
      window.addEventListener('storage', function(e) {
        if (e.key === 'publishedMarks' || e.key === 'marksPublished' || e.key === 'publishedExamData') {
          // Reload published data
          loadPublishedData();
          
          // Show notification
          showToast('New results have been published! Refreshing data...', 'info');
          
          // Reload the current view if student is logged in
          if (currentUser) {
            setTimeout(() => {
              const activeView = document.querySelector('.view-toggle-btn.active');
              if (activeView) {
                if (activeView.id === 'viewMyMarksBtn') {
                  displayMyMarks();
                } else if (activeView.id === 'viewMidtermBtn') {
                  displayMidtermMarks();
                } else if (activeView.id === 'viewDisciplineBtn') {
                  displayDisciplineRecords();
                } else if (activeView.id === 'viewAcademicResultsBtn') {
                  displayAcademicResults();
                }
              }
              showToast('Results updated successfully!', 'success');
            }, 500);
          }
        }
      });

      // Set up event listeners
      studentLoginBtn.addEventListener('click', handleStudentLogin);
      adminLoginBtn.addEventListener('click', handleAdminLogin);
      parentLoginBtn.addEventListener('click', handleParentLogin);
      logoutBtn.addEventListener('click', handleLogout);
      headerLoginBtn.addEventListener('click', showLogin);
      viewMyMarksBtn.addEventListener('click', () => toggleView('marks'));
      viewMidtermBtn.addEventListener('click', () => toggleView('midterm'));
      viewDisciplineBtn.addEventListener('click', () => toggleView('discipline'));
      viewAcademicResultsBtn.addEventListener('click', () => toggleView('academicResults'));
      publishBtn.addEventListener('click', publishResults);
      unpublishBtn.addEventListener('click', unpublishResults);
      editModeBtn.addEventListener('click', toggleEditMode);
      viewPublishedBtn.addEventListener('click', toggleViewPublished);
      studentSearch.addEventListener('input', filterStudents);
      downloadResultsBtn.addEventListener('click', downloadResults);
      calculateResultsBtn.addEventListener('click', calculateResults);

      // Set up login tabs
      loginTabs.forEach(tab => {
        tab.addEventListener('click', function() {
          const tabId = this.getAttribute('data-tab');
          
          // Update active tab
          loginTabs.forEach(t => t.classList.remove('active'));
          this.classList.add('active');
          
          // Show corresponding form
          loginForms.forEach(form => form.classList.add('hidden'));
          document.getElementById(`${tabId}LoginForm`).classList.remove('hidden');
        });
      });

      // Set up class filter buttons
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          filterStudents();
        });
      });

      // Set up autocomplete for student names
      setupAutocomplete();

      // Load published data
      loadPublishedData();
    });

    // Show login section
    function showLogin() {
      loginSection.classList.remove('hidden');
      content.classList.add('hidden');
    }

    // Handle student login
    function handleStudentLogin() {
      const name = studentNameInput.value.trim();
      const className = studentClassSelect.value;

      if (!name || !className) {
        showLoginError('Please enter both name and class');
        return;
      }

      // Check if student exists in the selected class
      const classStudents = studentData[className] || [];
      const studentExists = classStudents.some(student => 
        student.toLowerCase().includes(name.toLowerCase())
      );

      if (studentExists) {
        currentUser = { name, className, role: 'student' };
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        localStorage.setItem('isAdmin', 'false');
        localStorage.setItem('isViewingPublished', 'false');
        showContent();
        showToast(`Welcome ${name}!`, 'success');
      } else {
        showLoginError('Invalid name or class. Please check your information and try again.');
      }
    }

    // Handle admin login
    function handleAdminLogin() {
      const username = adminUsernameInput.value.trim();
      const password = adminPasswordInput.value;

      if (!username || !password) {
        showLoginError('Please enter both username and password');
        return;
      }

      if (username === adminCredentials.username && password === adminCredentials.password) {
        currentUser = { name: "Administrator", role: 'admin' };
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        localStorage.setItem('isAdmin', 'true');
        localStorage.setItem('isViewingPublished', 'false');
        showContent();
        showToast('Welcome Administrator!', 'success');
      } else {
        showLoginError('Invalid admin credentials. Please try again.');
      }
    }

    // Handle parent login
    function handleParentLogin() {
      const studentName = parentStudentNameInput.value.trim();
      const className = parentStudentClassSelect.value;
      const parentName = parentNameInput.value.trim();

      if (!studentName || !className || !parentName) {
        showLoginError('Please fill in all fields');
        return;
      }

      // Check if student exists in the selected class
      const classStudents = studentData[className] || [];
      const studentExists = classStudents.some(student => 
        student.toLowerCase().includes(studentName.toLowerCase())
      );

      if (studentExists) {
        currentUser = { name: studentName, className, parentName, role: 'parent' };
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        localStorage.setItem('isAdmin', 'false');
        localStorage.setItem('isViewingPublished', 'true');
        isViewingPublished = true;
        showContent();
        showToast(`Welcome ${parentName}!`, 'success');
      } else {
        showLoginError('Invalid student name or class. Please check your information and try again.');
      }
    }

    // Show login error
    function showLoginError(message) {
      loginErrorMessage.textContent = message;
      loginError.classList.remove('hidden');
      setTimeout(() => {
        loginError.classList.add('hidden');
      }, 5000);
    }

    // Handle logout
    function handleLogout() {
      currentUser = null;
      isAdmin = false;
      isEditMode = false;
      isViewingPublished = false;
      selectedStudent = null;
      localStorage.removeItem('currentUser');
      localStorage.removeItem('isAdmin');
      localStorage.removeItem('isViewingPublished');
      loginSection.classList.remove('hidden');
      content.classList.add('hidden');
      studentNameInput.value = '';
      studentClassSelect.value = '';
      parentStudentNameInput.value = '';
      parentStudentClassSelect.value = '';
      parentNameInput.value = '';
      adminUsernameInput.value = '';
      adminPasswordInput.value = '';
      showToast('You have been logged out successfully', 'info');
    }

    // Show content after login
    function showContent() {
      loginSection.classList.add('hidden');
      content.classList.remove('hidden');

      // Show admin panel if user is admin
      isAdmin = currentUser.role === 'admin';
      if (isAdmin) {
        adminPanel.classList.remove('hidden');
        studentSelection.classList.remove('hidden');
        userRoleText.textContent = "Manage student records and publish results.";
        populateStudentGrid();
      } else {
        adminPanel.classList.add('hidden');
        studentSelection.classList.add('hidden');
        if (currentUser.role === 'parent') {
          userRoleText.textContent = `Viewing ${currentUser.name}'s academic and disciplinary records.`;
        } else {
          userRoleText.textContent = "View your academic marks and disciplinary records.";
        }
      }

      // Update publish status display
      updatePublishStatusDisplay();

      // Show appropriate view based on user role
      if (currentUser.role === 'admin') {
        // Admin sees student selection first
        viewMyMarksBtn.classList.add('hidden');
        viewMidtermBtn.classList.add('hidden');
        viewDisciplineBtn.classList.add('hidden');
        viewAcademicResultsBtn.classList.add('hidden');
        myMarksSection.classList.add('hidden');
        midtermSection.classList.add('hidden');
        disciplineSection.classList.add('hidden');
        academicResultsSection.classList.add('hidden');
      } else {
        // Students and parents see their data directly
        viewMyMarksBtn.classList.remove('hidden');
        viewMidtermBtn.classList.remove('hidden');
        viewDisciplineBtn.classList.remove('hidden');
        viewAcademicResultsBtn.classList.remove('hidden');
        toggleView('midterm');
      }
    }

    // Populate student grid for admin view
    function populateStudentGrid() {
      studentGrid.innerHTML = '';
      
      for (const [className, students] of Object.entries(studentData)) {
        students.forEach(studentName => {
          const studentCard = document.createElement('div');
          studentCard.className = 'student-card bg-white border rounded-lg p-4 flex items-center space-x-3';
          studentCard.dataset.class = className;
          studentCard.dataset.name = studentName;
          
          const avatar = document.createElement('div');
          avatar.className = 'student-avatar';
          avatar.textContent = studentName.split(' ').map(n => n[0]).join('').substring(0, 2);
          
          const info = document.createElement('div');
          info.className = 'flex-1';
          
          const name = document.createElement('div');
          name.className = 'font-medium text-gray-900';
          name.textContent = studentName;
          
          const classInfo = document.createElement('div');
          classInfo.className = 'text-sm text-gray-500';
          classInfo.textContent = className;
          
          info.appendChild(name);
          info.appendChild(classInfo);
          
          studentCard.appendChild(avatar);
          studentCard.appendChild(info);
          
          studentCard.addEventListener('click', () => selectStudent(studentName, className));
          
          studentGrid.appendChild(studentCard);
        });
      }
    }

    // Filter students based on search and class filter
    function filterStudents() {
      const searchTerm = studentSearch.value.toLowerCase();
      const activeFilter = document.querySelector('.filter-btn.active').dataset.class;
      
      document.querySelectorAll('.student-card').forEach(card => {
        const studentName = card.dataset.name.toLowerCase();
        const className = card.dataset.class;
        
        const matchesSearch = studentName.includes(searchTerm);
        const matchesFilter = activeFilter === 'all' || className.includes(activeFilter);
        
        if (matchesSearch && matchesFilter) {
          card.classList.remove('hidden');
        } else {
          card.classList.add('hidden');
        }
      });
    }

    // Select a student (admin view)
    function selectStudent(studentName, className) {
      selectedStudent = { name: studentName, className };
      
      // Update UI to show the selected student
      document.querySelectorAll('.student-card').forEach(card => {
        if (card.dataset.name === studentName && card.dataset.class === className) {
          card.classList.add('border-blue-500', 'bg-blue-50');
        } else {
          card.classList.remove('border-blue-500', 'bg-blue-50');
        }
      });
      
      // Show the view controls
      viewMyMarksBtn.classList.remove('hidden');
      viewMidtermBtn.classList.remove('hidden');
      viewDisciplineBtn.classList.remove('hidden');
      viewAcademicResultsBtn.classList.remove('hidden');
      
      // Load the student data
      toggleView('midterm');
    }

    // Toggle between marks and discipline views
    function toggleView(view) {
      // Remove active class from all buttons
      viewMyMarksBtn.classList.remove('active');
      viewMidtermBtn.classList.remove('active');
      viewDisciplineBtn.classList.remove('active');
      viewAcademicResultsBtn.classList.remove('active');
      
      // Hide all sections
      myMarksSection.classList.add('hidden');
      midtermSection.classList.add('hidden');
      disciplineSection.classList.add('hidden');
      academicResultsSection.classList.add('hidden');
      
      if (view === 'marks') {
        viewMyMarksBtn.classList.add('active');
        myMarksSection.classList.remove('hidden');
        displayMyMarks();
      } else if (view === 'midterm') {
        viewMidtermBtn.classList.add('active');
        midtermSection.classList.remove('hidden');
        displayMidtermMarks();
      } else if (view === 'discipline') {
        viewDisciplineBtn.classList.add('active');
        disciplineSection.classList.remove('hidden');
        displayDisciplineRecords();
      } else if (view === 'academicResults') {
        viewAcademicResultsBtn.classList.add('active');
        academicResultsSection.classList.remove('hidden');
        displayAcademicResults();
      }
    }

    // Get grade class for styling
    function getGradeClass(grade) {
      if (grade.includes('A+') || grade.includes('A')) return 'grade-excellent';
      if (grade.includes('B+') || grade.includes('B')) return 'grade-good';
      if (grade.includes('C+') || grade.includes('C')) return 'grade-average';
      return 'grade-poor';
    }

    // Display midterm marks for the current user
    function displayMidtermMarks() {
      if (!currentUser) return;

      // For admin, use the selected student
      const studentInfo = isAdmin ? selectedStudent : currentUser;
      if (!studentInfo) return;
      
      const className = studentInfo.className;
      const studentName = studentInfo.name;
      
      // Load published marks from localStorage
      let publishedMarks;
      try {
        publishedMarks = JSON.parse(localStorage.getItem('publishedMarks') || '{}');
      } catch (e) {
        publishedMarks = {};
      }
      
      const classMarks = publishedMarks[className];
      
      if (!classMarks) {
        midtermContent.innerHTML = `
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <p class="text-blue-700 font-medium">Your marks are being prepared!</p>
            <p class="text-sm text-blue-600 mt-2">No class data yet for ${className}. Marks will appear as soon as your teachers enter them.</p>
          </div>
        `;
        return;
      }

      // Find matching student name (case-insensitive partial match)
      let actualStudentName = studentName;
      let studentFound = false;
      
      // Try to find the student in the class marks with flexible matching
      for (const midtermKey in classMarks) {
        const studentsInMidterm = Object.keys(classMarks[midtermKey] || {});
        const matchedName = studentsInMidterm.find(name => 
          name.toLowerCase().includes(studentName.toLowerCase()) || 
          studentName.toLowerCase().includes(name.toLowerCase())
        );
        
        if (matchedName) {
          actualStudentName = matchedName;
          studentFound = true;
          break;
        }
      }
      
      // Get marks for each midterm using the matched name
      const midterm1 = classMarks.midterm1 && classMarks.midterm1[actualStudentName] ? classMarks.midterm1[actualStudentName] : '';
      const midterm2 = classMarks.midterm2 && classMarks.midterm2[actualStudentName] ? classMarks.midterm2[actualStudentName] : '';
      const midterm3 = classMarks.midterm3 && classMarks.midterm3[actualStudentName] ? classMarks.midterm3[actualStudentName] : '';
      
      // Check if any marks exist
      const hasAnyMarks = midterm1 !== '' || midterm2 !== '' || midterm3 !== '';
      
      // Always show the table even if no marks yet, but with a friendly message
      if (!hasAnyMarks) {
        midtermContent.innerHTML = `
          <div class="mb-4">
            <h4 class="text-md font-semibold text-blue-800">Student: ${studentName}</h4>
            <p class="text-sm text-gray-600">Class: ${className}</p>
          </div>
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <p class="text-blue-700 font-medium">Your marks are being prepared!</p>
            <p class="text-sm text-blue-600 mt-2">Midterm marks will appear here as soon as your teachers enter them. Please check back later or contact your class teacher.</p>
            <div class="mt-4">
              <div class="text-sm text-gray-600">Status:</div>
              <div class="text-xs text-gray-500 mt-1">• Midterm 1: Pending</div>
              <div class="text-xs text-gray-500">• Midterm 2: Pending</div>
              <div class="text-xs text-gray-500">• Midterm 3: Pending</div>
            </div>
          </div>
        `;
        return;
      }
      
      // Calculate average
      let average = '';
      let validMarksCount = 0;
      let totalMarks = 0;
      
      if (midterm1 && midterm1 !== '') {
        validMarksCount++;
        totalMarks += parseFloat(midterm1);
      }
      if (midterm2 && midterm2 !== '') {
        validMarksCount++;
        totalMarks += parseFloat(midterm2);
      }
      if (midterm3 && midterm3 !== '') {
        validMarksCount++;
        totalMarks += parseFloat(midterm3);
      }
      
      if (validMarksCount > 0) {
        average = (totalMarks / validMarksCount).toFixed(1);
      }
      
      // Build HTML for midterm marks table
      let html = `
        <div class="mb-4">
          <h4 class="text-md font-semibold text-blue-800">Student: ${actualStudentName}</h4>
          <p class="text-sm text-gray-600">Class: ${className}</p>
        </div>
        <div class="overflow-x-auto">
          <table class="excel-table">
            <thead>
              <tr>
                <th>Term</th>
                <th>Midterm 1</th>
                <th>Midterm 2</th>
                <th>Midterm 3</th>
                <th>Average</th>
              </tr>
            </thead>
            <tbody>
      `;
      
      html += `
        <tr>
          <td class="font-semibold">Full Year</td>
          <td>${midterm1 !== '' ? midterm1 : 'Not yet entered'}</td>
          <td>${midterm2 !== '' ? midterm2 : 'Not yet entered'}</td>
          <td>${midterm3 !== '' ? midterm3 : 'Not yet entered'}</td>
          <td class="font-bold">${average ? average + '%' : 'Calculate when all marks available'}</td>
        </tr>
      `;
      
      html += `
            </tbody>
          </table>
        </div>
        
        <!-- Performance Summary -->
        <div class="mt-6 bg-gray-50 p-4 rounded-lg">
          <h4 class="font-semibold text-blue-800 mb-3">Midterm Performance Summary</h4>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="text-center p-3 bg-white rounded border">
              <div class="text-sm text-gray-600">Midterm 1</div>
              <div class="text-2xl font-bold ${midterm1 !== '' ? 'text-blue-700' : 'text-gray-400'}">${midterm1 !== '' ? midterm1 : 'N/A'}</div>
            </div>
            <div class="text-center p-3 bg-white rounded border">
              <div class="text-sm text-gray-600">Midterm 2</div>
              <div class="text-2xl font-bold ${midterm2 !== '' ? 'text-blue-700' : 'text-gray-400'}">${midterm2 !== '' ? midterm2 : 'N/A'}</div>
            </div>
            <div class="text-center p-3 bg-white rounded border">
              <div class="text-sm text-gray-600">Midterm 3</div>
              <div class="text-2xl font-bold ${midterm3 !== '' ? 'text-blue-700' : 'text-gray-400'}">${midterm3 !== '' ? midterm3 : 'N/A'}</div>
            </div>
          </div>
        </div>
      `;
      
      midtermContent.innerHTML = html;
    }

    // Display term marks for the current user
    function displayMyMarks() {
      if (!currentUser) return;

      // For admin, use the selected student
      const studentInfo = isAdmin ? selectedStudent : currentUser;
      if (!studentInfo) return;
      
      const className = studentInfo.className;
      const studentName = studentInfo.name;
      
      // Get the data source based on viewing mode
      const dataSource = isViewingPublished ? publishedData.termMarks : termMarksData;
      
      const classMarks = dataSource[className] || {};
      
      // Find the exact student name match
      let exactMatch = null;
      for (const name in classMarks) {
        if (name.toLowerCase().includes(studentName.toLowerCase())) {
          exactMatch = name;
          break;
        }
      }

      if (!exactMatch) {
        myMarksContent.innerHTML = `
          <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
            <p class="text-yellow-700">No academic records found for ${studentName} in ${className}.</p>
          </div>
        `;
        return;
      }

      const student = classMarks[exactMatch];
      const terms = student.terms;
      const yearTotal = student.yearTotal;
      
      let html = `
        <div class="mb-4">
          <h4 class="text-md font-semibold text-blue-800">Student: ${exactMatch}</h4>
          <p class="text-sm text-gray-600">Class: ${className}</p>
          <span class="program-badge program-${student.program.toLowerCase().replace(' ', '-').replace("'", '')}">
            ${student.program}
          </span>
        </div>
        <div class="overflow-x-auto">
          <table class="excel-table">
            <thead>
              <tr>
                <th>Term</th>
                <th>Average Mark</th>
                <th>Class Average</th>
                <th>Position</th>
                <th>Grade</th>
                <th>Remarks</th>
                ${isAdmin && !isViewingPublished ? '<th>Actions</th>' : ''}
              </tr>
            </thead>
            <tbody>
      `;
      
      for (const [termName, termData] of Object.entries(terms)) {
        html += `
          <tr>
            <td class="font-semibold">${termName}</td>
            <td class="font-bold">${termData.average}%</td>
            <td>${termData.classAverage}%</td>
            <td>${termData.position}</td>
            <td><span class="grade-cell ${getGradeClass(termData.grade)}">${termData.grade}</span></td>
            <td class="text-sm">${termData.remarks}</td>
            ${isAdmin && !isViewingPublished ? `
            <td>
              <button class="edit-term-btn text-xs text-blue-600 hover:text-blue-800" data-term="${termName}">
                Edit
              </button>
            </td>
            ` : ''}
          </tr>
        `;
      }
      
      // Add year total row
      html += `
          <tr class="bg-blue-50 font-bold">
            <td>YEAR TOTAL</td>
            <td>${yearTotal.average}%</td>
            <td>${yearTotal.classAverage}%</td>
            <td>${yearTotal.position}</td>
            <td><span class="grade-cell ${getGradeClass(yearTotal.grade)}">${yearTotal.grade}</span></td>
            <td class="text-sm">${yearTotal.remarks}</td>
            ${isAdmin && !isViewingPublished ? '<td></td>' : ''}
          </tr>
        </tbody>
      </table>
    </div>
    
    <!-- Performance Summary -->
    <div class="mt-6 bg-gray-50 p-4 rounded-lg">
      <h4 class="font-semibold text-blue-800 mb-3">Performance Summary</h4>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="text-center p-3 bg-white rounded border">
          <div class="text-sm text-gray-600">Overall Average</div>
          <div class="text-2xl font-bold text-blue-700">${yearTotal.average}%</div>
        </div>
        <div class="text-center p-3 bg-white rounded border">
          <div class="text-sm text-gray-600">Class Position</div>
          <div class="text-2xl font-bold text-blue-700">${yearTotal.position}</div>
        </div>
        <div class="text-center p-3 bg-white rounded border">
          <div class="text-sm text-gray-600">Final Grade</div>
          <div class="text-2xl font-bold ${getGradeClass(yearTotal.grade)}">${yearTotal.grade}</div>
        </div>
      </div>
    </div>
      `;
      
      myMarksContent.innerHTML = html;

      // Add event listeners for edit buttons if in admin mode
      if (isAdmin && !isViewingPublished) {
        document.querySelectorAll('.edit-term-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const term = this.getAttribute('data-term');
            editTermMarks(term, exactMatch, className);
          });
        });
      }
    }

    // Display academic results in the new format
    function displayAcademicResults() {
      if (!currentUser) return;

      // For admin, use the selected student
      const studentInfo = isAdmin ? selectedStudent : currentUser;
      if (!studentInfo) return;
      
      const className = studentInfo.className;
      const studentName = studentInfo.name;
      
      // Get the data source based on viewing mode
      const dataSource = isViewingPublished ? publishedData.termMarks : termMarksData;
      
      const classMarks = dataSource[className] || {};
      
      // Find the exact student name match
      let exactMatch = null;
      for (const name in classMarks) {
        if (name.toLowerCase().includes(studentName.toLowerCase())) {
          exactMatch = name;
          break;
        }
      }

      if (!exactMatch) {
        resultsTableBody.innerHTML = `
          <tr>
            <td colspan="7" class="text-center py-4">
              <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <p class="text-yellow-700">No academic records found for ${studentName} in ${className}.</p>
              </div>
            </td>
          </tr>
        `;
        return;
      }

      const student = classMarks[exactMatch];
      const terms = student.terms;
      const yearTotal = student.yearTotal;
      
      // Update student info
      resultsStudentName.textContent = `Student: ${exactMatch}`;
      resultsStudentClass.textContent = `Class: ${className}`;
      
      // Update summary
      overallAverage.textContent = `${yearTotal.average}%`;
      classPosition.textContent = yearTotal.position;
      finalGrade.textContent = yearTotal.grade;
      
      // Build results table
      let html = '';
      
      for (const [termName, termData] of Object.entries(terms)) {
        html += `
          <tr>
            <td class="font-semibold">${termName}</td>
            <td class="highlight">${termData.average}%</td>
            <td>${termData.classAverage}%</td>
            <td>${termData.position}</td>
            <td><span class="grade-cell ${getGradeClass(termData.grade)}">${termData.grade}</span></td>
            <td class="text-sm">${termData.remarks}</td>
            <td>
              ${isAdmin && !isViewingPublished ? `
              <button class="edit-term-btn text-xs text-blue-600 hover:text-blue-800" data-term="${termName}">
                Edit
              </button>
              ` : ''}
            </td>
          </tr>
        `;
      }
      
      // Add year total row
      html += `
        <tr class="year-total">
          <td>YEAR TOTAL</td>
          <td class="highlight">${yearTotal.average}%</td>
          <td class="highlight">${yearTotal.classAverage}%</td>
          <td>${yearTotal.position}</td>
          <td><span class="grade-cell ${getGradeClass(yearTotal.grade)}">${yearTotal.grade}</span></td>
          <td class="text-sm"><strong>${yearTotal.remarks}</strong></td>
          <td></td>
        </tr>
      `;
      
      resultsTableBody.innerHTML = html;

      // Add event listeners for edit buttons if in admin mode
      if (isAdmin && !isViewingPublished) {
        document.querySelectorAll('.edit-term-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const term = this.getAttribute('data-term');
            editTermMarks(term, exactMatch, className);
          });
        });
      }
    }

    // Edit term marks (admin only)
    function editTermMarks(term, studentName, className) {
      if (!isAdmin || isViewingPublished) return;

      // Create a modal to edit term marks
      const termData = termMarksData[className][studentName].terms[term];
      
      let html = `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <h3 class="text-lg font-semibold mb-4">Edit ${term} Marks for ${studentName}</h3>
            <div class="space-y-4">
      `;
      
      for (const [field, value] of Object.entries(termData)) {
        const inputType = field === 'remarks' ? 'textarea' : 
                         field === 'average' || field === 'classAverage' ? 'number' : 'text';
        
        html += `
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">${field.charAt(0).toUpperCase() + field.slice(1)}</label>
            ${inputType === 'textarea' ? 
              `<textarea class="w-full border rounded px-3 py-2 text-sm mark-input-${field}" rows="3">${value}</textarea>` :
              `<input type="${inputType}" value="${value}" class="w-full border rounded px-3 py-2 text-sm mark-input-${field}">`
            }
          </div>
        `;
      }
      
      html += `
            </div>
            <div class="mt-6 flex justify-end space-x-3">
              <button class="cancel-btn">Cancel</button>
              <button class="save-btn">Save Changes</button>
            </div>
          </div>
        </div>
      `;
      
      const modal = document.createElement('div');
      modal.innerHTML = html;
      document.body.appendChild(modal);
      
      modal.querySelector('.save-btn').addEventListener('click', function() {
        let hasError = false;
        
        for (const field of Object.keys(termData)) {
          const input = modal.querySelector(`.mark-input-${field}`);
          let newValue = input.value;
          
          // Validate numeric fields
          if (field === 'average' || field === 'classAverage') {
            newValue = parseFloat(newValue);
            if (isNaN(newValue) || newValue < 0 || newValue > 100) {
              alert(`Please enter a valid ${field} between 0 and 100`);
              hasError = true;
              break;
            }
          }
          
          // Validate position field
          if (field === 'position') {
            newValue = parseInt(newValue);
            if (isNaN(newValue) || newValue < 1) {
              alert(`Please enter a valid ${field}`);
              hasError = true;
              break;
            }
          }
          
          termMarksData[className][studentName].terms[term][field] = newValue;
        }
        
        if (!hasError) {
          document.body.removeChild(modal);
          displayAcademicResults();
          showToast(`${term} marks updated for ${studentName}`, 'success');
        }
      });
      
      modal.querySelector('.cancel-btn').addEventListener('click', function() {
        document.body.removeChild(modal);
      });
    }

    // Display discipline records for the current user
    function displayDisciplineRecords() {
      if (!currentUser) return;

      // For admin, use the selected student
      const studentInfo = isAdmin ? selectedStudent : currentUser;
      if (!studentInfo) return;
      
      const className = studentInfo.className;
      const studentName = studentInfo.name;
      
      // Get the data source based on viewing mode
      const dataSource = isViewingPublished ? publishedData.disciplineData : disciplineData;
      
      const classDiscipline = dataSource[className] || {};
      
      // Find the exact student name match
      let exactMatch = null;
      for (const name in classDiscipline) {
        if (name.toLowerCase().includes(studentName.toLowerCase())) {
          exactMatch = name;
          break;
        }
      }

      if (!exactMatch) {
        disciplineContent.innerHTML = `
          <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
            <p class="text-yellow-700">No disciplinary records found for ${studentName} in ${className}.</p>
          </div>
        `;
        return;
      }

      const discipline = classDiscipline[exactMatch];
      
      let html = `
        <div class="mb-4">
          <h4 class="text-md font-semibold text-blue-800">Student: ${exactMatch}</h4>
          <p class="text-sm text-gray-600">Class: ${className}</p>
        </div>
        <div class="overflow-x-auto">
          <table class="excel-table">
            <thead>
              <tr>
                <th>Term</th>
                <th>Discipline Marks</th>
                <th>Rating</th>
                <th>Violations</th>
              </tr>
            </thead>
            <tbody>
      `;
      
      for (const [term, data] of Object.entries(discipline)) {
        let ratingClass = '';
        let ratingText = '';
        
        if (data.marks >= 36) {
          ratingClass = 'discipline-excellent';
          ratingText = 'Excellent';
        } else if (data.marks >= 30) {
          ratingClass = 'discipline-good';
          ratingText = 'Good';
        } else if (data.marks >= 20) {
          ratingClass = 'discipline-fair';
          ratingText = 'Fair';
        } else {
          ratingClass = 'discipline-poor';
          ratingText = 'Poor';
        }
        
        const violationsHtml = data.violations.length > 0 
          ? data.violations.map(violation => {
              let violationClass = 'violation-other';
              if (violation.toLowerCase().includes('late')) violationClass = 'violation-late';
              else if (violation.toLowerCase().includes('uniform')) violationClass = 'violation-uniform';
              else if (violation.toLowerCase().includes('homework')) violationClass = 'violation-homework';
              else if (violation.toLowerCase().includes('disruptive')) violationClass = 'violation-disruptive';
              else if (violation.toLowerCase().includes('disrespect')) violationClass = 'violation-disrespect';
              else if (violation.toLowerCase().includes('fighting')) violationClass = 'violation-fighting';
              
              return `<div class="violation-item ${violationClass}">${violation}</div>`;
            }).join('')
          : '<div class="text-green-600">No violations</div>';
        
        html += `
          <tr>
            <td>${term.toUpperCase()}</td>
            <td>${data.marks}/40</td>
            <td><span class="discipline-badge ${ratingClass}">${ratingText}</span></td>
            <td>${violationsHtml}</td>
          </tr>
        `;
      }
      
      html += `
            </tbody>
          </table>
        </div>
      `;
      
      disciplineContent.innerHTML = html;
    }

    // Set up autocomplete for student names
    function setupAutocomplete() {
      studentClassSelect.addEventListener('change', function() {
        const className = this.value;
        if (!className) return;

        // Create datalist for autocomplete
        let datalist = document.getElementById('studentNamesDatalist');
        if (!datalist) {
          datalist = document.createElement('datalist');
          datalist.id = 'studentNamesDatalist';
          document.body.appendChild(datalist);
          studentNameInput.setAttribute('list', 'studentNamesDatalist');
        }

        // Clear previous options
        datalist.innerHTML = '';

        // Add options for students in the selected class
        const students = studentData[className] || [];
        students.forEach(student => {
          const option = document.createElement('option');
          option.value = student;
          datalist.appendChild(option);
        });
      });
    }

    // Publish results (admin only)
    function publishResults() {
      if (!isAdmin) return;
      
      // Create a deep copy of the current data
      publishedData.termMarks = JSON.parse(JSON.stringify(termMarksData));
      publishedData.disciplineData = JSON.parse(JSON.stringify(disciplineData));
      
      // Save to localStorage to simulate server persistence
      localStorage.setItem('publishedData', JSON.stringify(publishedData));
      
      // Update UI
      isViewingPublished = true;
      localStorage.setItem('isViewingPublished', 'true');
      updatePublishStatusDisplay();
      
      // Refresh the current view
      if (viewMyMarksBtn.classList.contains('active')) {
        displayMyMarks();
      } else if (viewDisciplineBtn.classList.contains('active')) {
        displayDisciplineRecords();
      } else {
        displayAcademicResults();
      }
      
      showToast('Results have been published successfully! Students and parents can now view them.', 'success');
    }

    // Unpublish results (admin only)
    function unpublishResults() {
      if (!isAdmin) return;
      
      // Clear published data
      publishedData = {
        termMarks: {},
        disciplineData: {}
      };
      
      // Remove from localStorage
      localStorage.removeItem('publishedData');
      
      // Update UI
      isViewingPublished = false;
      localStorage.setItem('isViewingPublished', 'false');
      updatePublishStatusDisplay();
      
      // Refresh the current view
      if (viewMyMarksBtn.classList.contains('active')) {
        displayMyMarks();
      } else if (viewDisciplineBtn.classList.contains('active')) {
        displayDisciplineRecords();
      } else {
        displayAcademicResults();
      }
      
      showToast('Results have been unpublished. Students and parents can no longer view them.', 'success');
    }

    // Toggle edit mode (admin only)
    function toggleEditMode() {
      if (!isAdmin) return;
      
      isEditMode = !isEditMode;
      editModeBtn.textContent = isEditMode ? 
        'Exit Edit Mode' : 'Toggle Edit Mode';
      
      // Refresh the current view to show/hide edit controls
      if (viewMyMarksBtn.classList.contains('active')) {
        displayMyMarks();
      } else if (viewAcademicResultsBtn.classList.contains('active')) {
        displayAcademicResults();
      }
    }

    // Toggle between viewing draft and published data
    function toggleViewPublished() {
      if (!isAdmin) return;
      
      isViewingPublished = !isViewingPublished;
      localStorage.setItem('isViewingPublished', isViewingPublished.toString());
      updatePublishStatusDisplay();
      
      // Refresh the current view
      if (viewMyMarksBtn.classList.contains('active')) {
        displayMyMarks();
      } else if (viewDisciplineBtn.classList.contains('active')) {
        displayDisciplineRecords();
      } else {
        displayAcademicResults();
      }
    }

    // Update the publish status display (no longer needed with real-time sync)
    function updatePublishStatusDisplay() {
      // Real-time sync enabled - no draft mode needed
      // Status banner is now static showing real-time sync is active
    }

    // Load published data from localStorage if available
    function loadPublishedData() {
      const savedPublishedData = localStorage.getItem('publishedData');
      if (savedPublishedData) {
        publishedData = JSON.parse(savedPublishedData);
      }
      
      // Also check for marks published from admin dashboard
      const adminPublishedMarks = localStorage.getItem('publishedMarks');
      const adminPublishedExams = localStorage.getItem('publishedExamData');
      const marksPublished = localStorage.getItem('marksPublished');
      
      if (marksPublished === 'true' && adminPublishedMarks) {
        // Load midterm marks from admin
        const adminMarks = JSON.parse(adminPublishedMarks);
        
        // Convert admin marks format to student portal format
        for (const className in adminMarks) {
          if (!publishedData.termMarks) publishedData.termMarks = {};
          if (!publishedData.termMarks[className]) publishedData.termMarks[className] = {};
          
          // Load midterm marks
          if (adminMarks[className].midterm1) {
            publishedData.termMarks[className].midterm1 = adminMarks[className].midterm1;
          }
          if (adminMarks[className].midterm2) {
            publishedData.termMarks[className].midterm2 = adminMarks[className].midterm2;
          }
          if (adminMarks[className].midterm3) {
            publishedData.termMarks[className].midterm3 = adminMarks[className].midterm3;
          }
        }
      }
      
      if (adminPublishedExams) {
        // Load exam marks from admin
        const adminExams = JSON.parse(adminPublishedExams);
        
        for (const className in adminExams) {
          if (!publishedData.termMarks) publishedData.termMarks = {};
          if (!publishedData.termMarks[className]) publishedData.termMarks[className] = {};
          
          // Load exam marks
          if (adminExams[className].term1) {
            publishedData.termMarks[className].term1 = adminExams[className].term1;
          }
          if (adminExams[className].term2) {
            publishedData.termMarks[className].term2 = adminExams[className].term2;
          }
          if (adminExams[className].term3) {
            publishedData.termMarks[className].term3 = adminExams[className].term3;
          }
        }
      }
      
      // Save the merged data
      if (marksPublished === 'true') {
        localStorage.setItem('publishedData', JSON.stringify(publishedData));
      }
    }

    // Download results as PDF
    function downloadResults() {
      // For demo purposes, we'll just show a toast message
      // In a real implementation, you would generate a PDF here
      showToast('Downloading results as PDF...', 'info');
      
      // Simulate PDF generation
      setTimeout(() => {
        showToast('Results downloaded successfully!', 'success');
      }, 1500);
    }

    // Calculate results
    function calculateResults() {
      // For demo purposes, we'll just show a toast message
      // In a real implementation, you would recalculate averages and positions
      showToast('Recalculating results...', 'info');
      
      // Simulate calculation
      setTimeout(() => {
        showToast('Results recalculated successfully!', 'success');
      }, 1500);
    }

    // Show toast notification
    function showToast(message, type) {
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }
  </script>
</body>
</html>