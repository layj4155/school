<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kageyo TVET — Advanced Marks Management</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="icon" type="image/png" sizes="32x32" href="kageyo-logo.jpg">
  <style>
    .card { border-radius: .75rem; box-shadow: 0 8px 24px rgba(2,6,23,0.06); }
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    .year-box { cursor: pointer; }
    .year-box:hover { background-color: #eff6ff; }
    .hidden { display: none; }
    .mark-input { 
      transition: all 0.2s ease; 
      border: 1px solid #d1d5db;
      width: 70px;
    }
    .mark-input:focus { 
      border-color: #8b5cf6;
      box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
      background-color: #faf5ff;
    }
    .mark-input.invalid {
      border-color: #dc2626;
      background-color: #fef2f2;
    }
    .total-cell { 
      background-color: #f8fafc;
      font-weight: 600;
      color: #1e40af;
    }
    .grade-cell {
      font-weight: 600;
      text-align: center;
      border-radius: 4px;
      padding: 4px 8px;
    }
    .grade-A { color: #059669; background-color: #d1fae5; }
    .grade-B { color: #0d9488; background-color: #ccfbf1; }
    .grade-C { color: #0e7490; background-color: #cffafe; }
    .grade-D { color: #92400e; background-color: #fef3c7; }
    .grade-F { color: #dc2626; background-color: #fee2e2; }
    .status-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 6px;
    }
    .status-complete { background-color: #10b981; }
    .status-partial { background-color: #f59e0b; }
    .status-pending { background-color: #ef4444; }
    .calculation-formula {
      font-family: monospace;
      background-color: #f3f4f6;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.875rem;
    }
    .auto-save-indicator {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: #10b981;
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.875rem;
      font-weight: 500;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .auto-save-indicator.show {
      opacity: 1;
    }
    .student-row:hover {
      background-color: #f8fafc;
    }
    .quick-actions {
      position: sticky;
      top: 0;
      background-color: white;
      z-index: 10;
      padding: 16px;
      border-bottom: 1px solid #e5e7eb;
      margin: -16px -16px 16px -16px;
    }
  </style>
</head>
<body class="bg-gray-50 font-sans antialiased text-gray-800">
  <!-- HEADER / NAVBAR -->
  <header class="bg-white shadow-sm">
    <div class="bg-purple-600 text-white py-2">
      <div class="container mx-auto px-4 flex justify-between items-center">
        <a href="#" class="hover:underline"><i class="fab fa-whatsapp mr-2"></i>Join WhatsApp Group</a>
        <select id="header-language-selector" class="p-1 rounded bg-white text-purple-600">
          <option value="en">English</option>
          <option value="rw">Kinyarwanda</option>
          <option value="fr">Français</option>
        </select>
      </div>
    </div>

    <div class="container mx-auto px-4 py-4">
      <nav class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <a href='index.html'>
            <img src="kageyo-logo.jpg" alt="Kageyo TVET School Logo" class="w-16 h-16 object-cover rounded-full shadow-sm">
          </a>
          <div>
            <a class='text-xl font-bold text-purple-600' href='/'>KAGEYO TVET SCHOOL</a>
            <div class="text-sm text-gray-500">Work - Courage - Solidarity</div>
          </div>
        </div>

        <div class="hidden md:flex items-center space-x-6">
          <a class='text-purple-600 hover:text-purple-800' href='/'>Home</a>
          <a class='text-purple-600 hover:text-purple-800' href='/about'>About Us</a>
          <a href="student-data.html" class="text-purple-600 hover:text-purple-800">Student Portal</a>
          <a href="admin-dashboard.html" class="text-purple-600 hover:text-purple-800">Admin Dashboard</a>
          <a class='text-purple-600 hover:text-purple-800' href='/contact'>Contact</a>
          <a class='px-3 py-2 bg-purple-600 text-white rounded' href='/login-new'>Login</a>
        </div>
      </nav>
    </div>
  </header>

  <!-- MAIN CONTENT -->
  <main class="container mx-auto px-4 py-6">
    <section class="card bg-white p-6">
      <div class="flex items-start justify-between">
        <div>
          <h1 class="text-xl font-bold text-purple-700">Advanced Marks Management System</h1>
          <p class="text-sm text-gray-600">Enter marks for all assessments. Totals, grades, and statistics update automatically in real-time.</p>
        </div>
        <div class="text-right text-sm text-gray-500">
          Academic Year: <strong>2025 - 2026</strong>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="quick-actions">
        <div class="flex flex-wrap gap-2 mb-4">
          <button id="fillEmptyBtn" class="px-3 py-1 bg-blue-600 text-white rounded text-sm font-medium hover:bg-blue-700">
            Fill Empty with 0
          </button>
          <button id="fillRandomBtn" class="px-3 py-1 bg-green-600 text-white rounded text-sm font-medium hover:bg-green-700">
            Fill Random (50-100)
          </button>
          <button id="clearAllBtn" class="px-3 py-1 bg-red-600 text-white rounded text-sm font-medium hover:bg-red-700">
            Clear All Marks
          </button>
          <button id="calculateAllBtn" class="px-3 py-1 bg-purple-600 text-white rounded text-sm font-medium hover:bg-purple-700">
            Recalculate All
          </button>
        </div>
        
        <!-- Calculation Formula Display -->
        <div class="text-xs text-gray-600 mb-2">
          <strong>Calculation Formula:</strong> 
          <span class="calculation-formula">Total = (Mid-Term + Term1 + Term2 + Term3 + Exam) ÷ 5</span>
          <span class="ml-4"><strong>Grading:</strong> A(80-100), B(70-79), C(60-69), D(50-59), F(0-49)</span>
        </div>
      </div>

      <!-- Stats Overview -->
      <div class="grid grid-cols-1 md:grid-cols-5 gap-4 my-6">
        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
          <div class="text-purple-600 font-semibold text-2xl" id="totalStudents">0</div>
          <div class="text-sm text-gray-600">Total Students</div>
        </div>
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
          <div class="text-blue-600 font-semibold text-2xl" id="completedStudents">0</div>
          <div class="text-sm text-gray-600">Complete Records</div>
        </div>
        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
          <div class="text-green-600 font-semibold text-2xl" id="classAverage">0%</div>
          <div class="text-sm text-gray-600">Class Average</div>
        </div>
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
          <div class="text-yellow-600 font-semibold text-2xl" id="passRate">0%</div>
          <div class="text-sm text-gray-600">Pass Rate</div>
        </div>
        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
          <div class="text-red-600 font-semibold text-2xl" id="failRate">0%</div>
          <div class="text-sm text-gray-600">Fail Rate</div>
        </div>
      </div>

      <!-- Detailed Statistics -->
      <div class="grid grid-cols-1 md:grid-cols-6 gap-2 mb-6 text-xs">
        <div class="text-center p-2 bg-gray-50 rounded">
          <div class="font-semibold">Mid-Term Avg</div>
          <div id="midTermAvg" class="text-purple-600">0%</div>
        </div>
        <div class="text-center p-2 bg-gray-50 rounded">
          <div class="font-semibold">Term 1 Avg</div>
          <div id="term1Avg" class="text-blue-600">0%</div>
        </div>
        <div class="text-center p-2 bg-gray-50 rounded">
          <div class="font-semibold">Term 2 Avg</div>
          <div id="term2Avg" class="text-green-600">0%</div>
        </div>
        <div class="text-center p-2 bg-gray-50 rounded">
          <div class="font-semibold">Term 3 Avg</div>
          <div id="term3Avg" class="text-yellow-600">0%</div>
        </div>
        <div class="text-center p-2 bg-gray-50 rounded">
          <div class="font-semibold">Exam Avg</div>
          <div id="examAvg" class="text-red-600">0%</div>
        </div>
        <div class="text-center p-2 bg-gray-100 rounded">
          <div class="font-semibold">Overall Avg</div>
          <div id="overallAvg" class="text-indigo-600 font-bold">0%</div>
        </div>
      </div>

      <!-- Search Box -->
      <div class="my-4">
        <input type="text" id="studentSearch" placeholder="Search student by name..." 
               class="w-full border rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-600">
        <div id="searchResults" class="mt-2"></div>
      </div>

      <hr class="my-4" />

      <!-- Classes list -->
      <div id="classesContainer" class="space-y-4 max-h-[70vh] overflow-auto pr-2">
        <!-- Populated by JS -->
      </div>

      <!-- Save Button -->
      <div class="p-4 mt-4 border-t">
        <div class="flex items-center justify-between">
          <div class="text-sm text-gray-700">
            <span id="lastSaved" class="text-gray-500">Changes auto-saved in real-time</span>
          </div>
          <div class="space-x-2">
            <button id="exportBtn" class="px-4 py-2 bg-green-600 text-white rounded font-semibold hover:bg-green-700">
              Export to CSV
            </button>
            <a href="admin-dashboard.html" class="px-5 py-2 bg-gray-600 text-white rounded font-semibold hover:bg-gray-700">Back to Dashboard</a>
          </div>
        </div>
        <div id="message" class="text-green-600 text-sm font-medium mt-2 hidden"></div>
      </div>
    </section>
  </main>

  <!-- Auto-save Indicator -->
  <div id="autoSaveIndicator" class="auto-save-indicator">
    <i class="fas fa-check-circle mr-2"></i>Auto-saved
  </div>

  <!-- SCRIPT -->
  <script>
    // Initial student data
    const initial = {
      "S1A": ["ABEREYIMANA James","ABIMANA HIRWA Gany Blessing","AHISHAKIYE MANZI Aime Miguel","ASHIMWE Nate Brayan","Benedicto King Samuel","BUGINGO BEZA Keny","GASHUMBA NDAYISHIMIYE KIM Kenedy","IGENUKWISHATSE BYISHIMO Jean Maurice","IGIRANEZA CYUSA Milton","IHUMURE NSENGIYUMVA Heroine","INEZA Queen Deborah","IRABARUTA MUGISHA Credo","IRAKOZE Belle Amie","IRAKOZE Janviere","IRAKOZE Yanis","ISHIMWE UWASE Gabriella","ISIMBI UWASE Joyeuse","ITANGANEZA Parfait","KAMIKAZI Patience","MUNEZERO Enock","MUNEZERO Priscilla","MUTONIWASE Benitha","MUVUNYI UWIMPUHWE Benie Hortance","MWITENEZA Jean Pierre","NDARUHUTSE Danny","NGABONZIZA MUGISHA Boris","NGANZO Born Bercee","RORIRORA Gihozo Anella","UWANYAGASANI Cedrick","UWASE Benitha","UWIDUHAYE Pascaline","UWINEZA AKALIZA Martina","UWIZEYIMANA Valentine","YUBAHWE Anitha"],
      "S1B": ["ABAYISENGA Emmu Shalom","AMANI NSHUTI Claver","ARERWENEZA Laetitia","BAGABE Dieudonne","CYOMORO Nicky Prince","GAGA Lioness","IGANZE Olla Mireille","IGIRIMBABAZI Pamella","INEZA Aure Alexandrine","INEZA Deborah","INEZA KAMIKAZI TETA Promesse","IRAGENA Gloria","IRAGENA Laetitia","IRAME MUCYO Angelo","ISHEMA Rayan","ISHIMWE NGABO Hertier","ISHIMWE Olga","ISINGIZWE Ange Afurika Maombe","KAYITARE Caleb","KEZA UMI Abdoulatomani","KUNDA Beny Bienaime","KWIZERA MUHOZA Prince","MANZI Boaz","MBABAZI Blessed","MUNEZERO Gentil Hertier","MUNEZERO Yvette","MUTONIWASE Esther","NDIKUMWENAYO Jeannette","NIRAGIRE Aline","NIYONZIMA Lucky","RUDASINGWA","SHAMI Ianis Vangelis","UWASE GASARO Kelia","UWASE Sendrine","UWIZEYIMANA Chakilla","UYIZERA Regis"]
    };

    // Load draft results from localStorage or initialize new
    let students = JSON.parse(localStorage.getItem('draftResults')) || [];
    if (students.length === 0) {
      Object.keys(initial).forEach(cls => {
        initial[cls].forEach((name, i) => {
          students.push({ 
            id: cls + '-' + (i+1), 
            name, 
            cls, 
            midTerm: 0, 
            t1: 0, 
            t2: 0, 
            t3: 0, 
            termExam: 0,
            total: 0,
            grade: 'F',
            status: 'pending'
          });
        });
      });
      calculateAllStudents();
      saveDraft();
    }

    const classesContainer = document.getElementById('classesContainer');
    const msg = document.getElementById('message');
    const searchInput = document.getElementById('studentSearch');
    const searchResults = document.getElementById('searchResults');
    const autoSaveIndicator = document.getElementById('autoSaveIndicator');
    const lastSaved = document.getElementById('lastSaved');

    // Auto-save timer
    let autoSaveTimeout;
    let lastSaveTime = new Date();

    function saveDraft() {
      localStorage.setItem('draftResults', JSON.stringify(students));
      lastSaveTime = new Date();
      lastSaved.textContent = `Last saved: ${lastSaveTime.toLocaleTimeString()}`;
      
      // Show auto-save indicator
      autoSaveIndicator.classList.add('show');
      setTimeout(() => {
        autoSaveIndicator.classList.remove('show');
      }, 2000);
    }

    function calculateAllStudents() {
      students.forEach(student => {
        calculateStudentTotal(student);
        updateStudentStatus(student);
      });
      updateGlobalStats();
    }

    function calculateStudentTotal(student) {
      const sum = Number(student.midTerm || 0) + 
                  Number(student.t1 || 0) + 
                  Number(student.t2 || 0) + 
                  Number(student.t3 || 0) + 
                  Number(student.termExam || 0);
      student.total = (sum / 5).toFixed(1);
      student.grade = getGrade(student.total).grade;
    }

    function updateStudentStatus(student) {
      const fields = [student.midTerm, student.t1, student.t2, student.t3, student.termExam];
      const filledFields = fields.filter(field => field > 0).length;
      
      if (filledFields === 5) {
        student.status = 'complete';
      } else if (filledFields > 0) {
        student.status = 'partial';
      } else {
        student.status = 'pending';
      }
    }

    function getGrade(total) {
      if (total >= 80) return { grade: 'A', class: 'grade-A', text: 'Excellent' };
      if (total >= 70) return { grade: 'B', class: 'grade-B', text: 'Very Good' };
      if (total >= 60) return { grade: 'C', class: 'grade-C', text: 'Good' };
      if (total >= 50) return { grade: 'D', class: 'grade-D', text: 'Pass' };
      return { grade: 'F', class: 'grade-F', text: 'Fail' };
    }

    function updateGlobalStats() {
      const totalStudents = students.length;
      const completedStudents = students.filter(s => s.status === 'complete').length;
      
      // Calculate averages
      const midTermSum = students.reduce((sum, s) => sum + Number(s.midTerm || 0), 0);
      const term1Sum = students.reduce((sum, s) => sum + Number(s.t1 || 0), 0);
      const term2Sum = students.reduce((sum, s) => sum + Number(s.t2 || 0), 0);
      const term3Sum = students.reduce((sum, s) => sum + Number(s.t3 || 0), 0);
      const examSum = students.reduce((sum, s) => sum + Number(s.termExam || 0), 0);
      const totalSum = students.reduce((sum, s) => sum + Number(s.total || 0), 0);
      
      const midTermAvg = (midTermSum / totalStudents).toFixed(1);
      const term1Avg = (term1Sum / totalStudents).toFixed(1);
      const term2Avg = (term2Sum / totalStudents).toFixed(1);
      const term3Avg = (term3Sum / totalStudents).toFixed(1);
      const examAvg = (examSum / totalStudents).toFixed(1);
      const overallAvg = (totalSum / totalStudents).toFixed(1);
      
      // Calculate pass/fail rates
      const passCount = students.filter(s => s.total >= 50).length;
      const failCount = totalStudents - passCount;
      const passRate = ((passCount / totalStudents) * 100).toFixed(1);
      const failRate = ((failCount / totalStudents) * 100).toFixed(1);
      
      // Update DOM
      document.getElementById('totalStudents').textContent = totalStudents;
      document.getElementById('completedStudents').textContent = completedStudents;
      document.getElementById('classAverage').textContent = overallAvg + '%';
      document.getElementById('passRate').textContent = passRate + '%';
      document.getElementById('failRate').textContent = failRate + '%';
      
      document.getElementById('midTermAvg').textContent = midTermAvg + '%';
      document.getElementById('term1Avg').textContent = term1Avg + '%';
      document.getElementById('term2Avg').textContent = term2Avg + '%';
      document.getElementById('term3Avg').textContent = term3Avg + '%';
      document.getElementById('examAvg').textContent = examAvg + '%';
      document.getElementById('overallAvg').textContent = overallAvg + '%';
    }

    function getStatusDot(status) {
      if (status === 'complete') return '<span class="status-dot status-complete"></span>';
      if (status === 'partial') return '<span class="status-dot status-partial"></span>';
      return '<span class="status-dot status-pending"></span>';
    }

    function render() {
      // Group classes by year
      const yearGroups = {};
      Object.keys(initial).forEach(cls => {
        const year = cls.match(/^([SL]\d+)/)[1]; // Extract S1, S2, etc.
        if (!yearGroups[year]) yearGroups[year] = [];
        yearGroups[year].push(cls);
      });

      const groups = {};
      students.forEach(s => {
        if (!groups[s.cls]) groups[s.cls] = [];
        groups[s.cls].push(s);
      });

      classesContainer.innerHTML = '';
      Object.keys(yearGroups).sort().forEach(year => {
        const box = document.createElement('div');
        box.className = 'border rounded p-3 year-box bg-white';
        box.innerHTML = `
          <h3 class="font-semibold text-purple-700 mb-2 flex justify-between items-center">
            ${year} <span class="text-gray-500 text-sm">(${yearGroups[year].reduce((sum, cls) => sum + groups[cls].length, 0)} students)</span>
            <span class="text-purple-600">▼</span>
          </h3>
          <div class="class-list">
            ${yearGroups[year].sort().map(cls => `
              <div class="mb-4">
                <h4 class="font-semibold text-purple-600 mb-2 flex items-center">
                  ${cls} (${groups[cls].length} students)
                  <span class="ml-2 text-xs font-normal">
                    ${getStatusDot('complete')}${groups[cls].filter(s => s.status === 'complete').length}
                    ${getStatusDot('partial')}${groups[cls].filter(s => s.status === 'partial').length}
                    ${getStatusDot('pending')}${groups[cls].filter(s => s.status === 'pending').length}
                  </span>
                </h4>
                <div class="overflow-auto">
                  <table class="w-full text-sm">
                    <thead><tr class="text-left text-xs text-gray-600 bg-gray-50">
                      <th class="pb-2 px-2">Student</th>
                      <th class="pb-2 px-2">Status</th>
                      <th class="pb-2 px-2">Mid-Term</th>
                      <th class="pb-2 px-2">Term 1</th>
                      <th class="pb-2 px-2">Term 2</th>
                      <th class="pb-2 px-2">Term 3</th>
                      <th class="pb-2 px-2">Exam</th>
                      <th class="pb-2 px-2">Total</th>
                      <th class="pb-2 px-2">Grade</th>
                    </tr></thead>
                    <tbody>
                      ${groups[cls].map(s => {
                        const grade = getGrade(s.total);
                        return `
                        <tr class="border-t student-row">
                          <td class="py-2 px-2">${s.name}</td>
                          <td class="py-2 px-2">${getStatusDot(s.status)}</td>
                          <td class="py-2 px-2">
                            <input type="number" min="0" max="100" value="${s.midTerm}" 
                                   data-id="${s.id}" data-field="midTerm" 
                                   class="mark-input border rounded px-2 py-1 text-sm" />
                          </td>
                          <td class="py-2 px-2">
                            <input type="number" min="0" max="100" value="${s.t1}" 
                                   data-id="${s.id}" data-field="t1" 
                                   class="mark-input border rounded px-2 py-1 text-sm" />
                          </td>
                          <td class="py-2 px-2">
                            <input type="number" min="0" max="100" value="${s.t2}" 
                                   data-id="${s.id}" data-field="t2" 
                                   class="mark-input border rounded px-2 py-1 text-sm" />
                          </td>
                          <td class="py-2 px-2">
                            <input type="number" min="0" max="100" value="${s.t3}" 
                                   data-id="${s.id}" data-field="t3" 
                                   class="mark-input border rounded px-2 py-1 text-sm" />
                          </td>
                          <td class="py-2 px-2">
                            <input type="number" min="0" max="100" value="${s.termExam}" 
                                   data-id="${s.id}" data-field="termExam" 
                                   class="mark-input border rounded px-2 py-1 text-sm" />
                          </td>
                          <td class="py-2 px-2 total-cell" id="total-${s.id}">${s.total}%</td>
                          <td class="py-2 px-2 grade-cell ${grade.class}" id="grade-${s.id}">${grade.grade}</td>
                        </tr>
                      `}).join('')}
                    </tbody>
                  </table>
                </div>
              </div>
            `).join('')}
          </div>`;
        classesContainer.appendChild(box);
        box.querySelector('h3').addEventListener('click', () => {
          const classList = box.querySelector('.class-list');
          const arrow = box.querySelector('h3 span:last-child');
          classList.classList.toggle('hidden');
          arrow.textContent = classList.classList.contains('hidden') ? '▼' : '▲';
        });
      });

      // Attach event listeners to input fields
      document.querySelectorAll('.mark-input').forEach(input => {
        input.addEventListener('input', (e) => {
          // Validate input
          const value = e.target.value;
          if (value > 100) {
            e.target.value = 100;
            e.target.classList.add('invalid');
          } else if (value < 0) {
            e.target.value = 0;
            e.target.classList.add('invalid');
          } else {
            e.target.classList.remove('invalid');
          }
          
          update(input.dataset.id, input.dataset.field, input.value);
        });
        
        // Add paste event listener for Excel-like behavior
        input.addEventListener('paste', (e) => {
          e.preventDefault();
          const pastedData = e.clipboardData.getData('text');
          const values = pastedData.split('\t');
          
          if (values.length > 1) {
            // Multiple values pasted (like from Excel)
            const row = input.closest('tr');
            const inputs = row.querySelectorAll('.mark-input');
            const startIndex = Array.from(inputs).indexOf(input);
            
            values.forEach((value, index) => {
              if (startIndex + index < inputs.length) {
                const targetInput = inputs[startIndex + index];
                const numValue = parseFloat(value) || 0;
                targetInput.value = Math.min(100, Math.max(0, numValue));
                update(targetInput.dataset.id, targetInput.dataset.field, targetInput.value);
              }
            });
          } else {
            // Single value pasted
            const numValue = parseFloat(pastedData) || 0;
            input.value = Math.min(100, Math.max(0, numValue));
            update(input.dataset.id, input.dataset.field, input.value);
          }
        });
      });

      updateGlobalStats();
    }

    function update(id, field, value) {
      const s = students.find(x => x.id === id);
      let v = Number(value) || 0;
      if (v > 100) v = 100;
      if (v < 0) v = 0;
      s[field] = v;
      
      // Recalculate student total and grade
      calculateStudentTotal(s);
      updateStudentStatus(s);
      
      // Update display
      document.getElementById(`total-${id}`).textContent = `${s.total}%`;
      const grade = getGrade(s.total);
      const gradeCell = document.getElementById(`grade-${id}`);
      gradeCell.textContent = grade.grade;
      gradeCell.className = `py-2 px-2 grade-cell ${grade.class}`;
      
      // Update status dot
      const row = document.querySelector(`[data-id="${id}"]`).closest('tr');
      const statusCell = row.querySelector('td:nth-child(2)');
      statusCell.innerHTML = getStatusDot(s.status);
      
      // Update global stats
      updateGlobalStats();
      
      // Auto-save with debounce
      clearTimeout(autoSaveTimeout);
      autoSaveTimeout = setTimeout(saveDraft, 1000);
    }

    function searchStudent(query) {
      searchResults.innerHTML = '';
      if (query.trim() === '') return;
      
      const results = students.filter(s => 
        s.name.toLowerCase().includes(query.toLowerCase())
      );

      if (results.length === 0) {
        searchResults.innerHTML = '<p class="text-sm text-gray-600">No students found.</p>';
        return;
      }

      results.forEach(s => {
        const grade = getGrade(s.total);
        
        const resultDiv = document.createElement('div');
        resultDiv.className = 'border rounded p-3 mb-2 bg-white';
        resultDiv.innerHTML = `
          <h4 class="font-semibold text-purple-700">${s.name} (${s.cls}) ${getStatusDot(s.status)}</h4>
          <div class="grid grid-cols-2 md:grid-cols-7 gap-2 mt-2 text-sm">
            <div>
              <span class="text-gray-600">Mid-Term:</span>
              <span class="font-medium">${s.midTerm}%</span>
            </div>
            <div>
              <span class="text-gray-600">Term 1:</span>
              <span class="font-medium">${s.t1}%</span>
            </div>
            <div>
              <span class="text-gray-600">Term 2:</span>
              <span class="font-medium">${s.t2}%</span>
            </div>
            <div>
              <span class="text-gray-600">Term 3:</span>
              <span class="font-medium">${s.t3}%</span>
            </div>
            <div>
              <span class="text-gray-600">Exam:</span>
              <span class="font-medium">${s.termExam}%</span>
            </div>
            <div>
              <span class="text-gray-600">Total:</span>
              <span class="font-medium">${s.total}%</span>
            </div>
            <div>
              <span class="text-gray-600">Grade:</span>
              <span class="font-medium ${grade.class} px-2 rounded">${grade.grade}</span>
            </div>
          </div>
        `;
        searchResults.appendChild(resultDiv);
      });
    }

    function fillEmptyWithZero() {
      students.forEach(student => {
        if (student.midTerm === 0) student.midTerm = 0;
        if (student.t1 === 0) student.t1 = 0;
        if (student.t2 === 0) student.t2 = 0;
        if (student.t3 === 0) student.t3 = 0;
        if (student.termExam === 0) student.termExam = 0;
      });
      calculateAllStudents();
      saveDraft();
      render();
      showMessage("All empty fields filled with 0");
    }

    function fillRandomMarks() {
      students.forEach(student => {
        if (student.midTerm === 0) student.midTerm = Math.floor(Math.random() * 51) + 50; // 50-100
        if (student.t1 === 0) student.t1 = Math.floor(Math.random() * 51) + 50;
        if (student.t2 === 0) student.t2 = Math.floor(Math.random() * 51) + 50;
        if (student.t3 === 0) student.t3 = Math.floor(Math.random() * 51) + 50;
        if (student.termExam === 0) student.termExam = Math.floor(Math.random() * 51) + 50;
      });
      calculateAllStudents();
      saveDraft();
      render();
      showMessage("Random marks (50-100) filled for empty fields");
    }

    function clearAllMarks() {
      if (confirm('Are you sure you want to clear all marks? This cannot be undone.')) {
        students.forEach(student => {
          student.midTerm = 0;
          student.t1 = 0;
          student.t2 = 0;
          student.t3 = 0;
          student.termExam = 0;
        });
        calculateAllStudents();
        saveDraft();
        render();
        showMessage("All marks cleared");
      }
    }

    function exportToCSV() {
      const headers = ['Class', 'Student', 'Mid-Term', 'Term 1', 'Term 2', 'Term 3', 'Exam', 'Total', 'Grade'];
      const rows = students.map(s => [
        s.cls,
        `"${s.name}"`,
        s.midTerm,
        s.t1,
        s.t2,
        s.t3,
        s.termExam,
        s.total,
        s.grade
      ]);
      
      const csvContent = [
        headers.join(','),
        ...rows.map(row => row.join(','))
      ].join('\n');
      
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `student_marks_${new Date().toISOString().split('T')[0]}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showMessage("Data exported to CSV successfully");
    }

    function showMessage(text) {
      msg.textContent = text;
      msg.classList.remove('hidden');
      setTimeout(() => {
        msg.classList.add('hidden');
      }, 3000);
    }

    // Event listeners
    searchInput.addEventListener('input', () => {
      searchStudent(searchInput.value);
    });

    document.getElementById('fillEmptyBtn').addEventListener('click', fillEmptyWithZero);
    document.getElementById('fillRandomBtn').addEventListener('click', fillRandomMarks);
    document.getElementById('clearAllBtn').addEventListener('click', clearAllMarks);
    document.getElementById('calculateAllBtn').addEventListener('click', () => {
      calculateAllStudents();
      saveDraft();
      render();
      showMessage("All calculations updated");
    });
    document.getElementById('exportBtn').addEventListener('click', exportToCSV);

    // Initialize
    calculateAllStudents();
    render();
    lastSaved.textContent = `Last saved: ${lastSaveTime.toLocaleTimeString()}`;
  </script>

  <script src="https://kit.fontawesome.com/a2e8b3b7d5.js" crossorigin="anonymous"></script>
</body>
</html>